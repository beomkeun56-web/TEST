<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BK v3.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        button { touch-action: manipulation; }
        .text-transition { transition: font-size 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-black text-gray-100 font-sans selection:bg-blue-500 selection:text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { ChevronLeft, ChevronRight, Plus, Minus, X, Wallet, TrendingUp, TrendingDown, Calendar as CalendarIcon, Settings, Moon, Sun, List, LayoutGrid, Download, Upload, Pencil, PieChart, BarChart3, Trash2, Scale, Layers, LineChart, Table2, StickyNote, FolderTree, Tag, ArrowRight } from 'lucide-react';

        const APP_VERSION = "v3.5";
        
        const FONT_SIZES = ['text-xs', 'text-sm', 'text-base', 'text-lg', 'text-xl', 'text-2xl', 'text-3xl', 'text-4xl'];
        const FONT_LABELS = ['80%', '90%', '100%', '110%', '120%', '130%', '140%', '150%'];
        
        const TABLE_FONT_SIZES = [
            'text-[9px]', 'text-[10px]', 'text-[11px]', 'text-[12px]', 'text-[13px]', 'text-[14px]', 'text-[15px]', 'text-[16px]'
        ];

        const formatCurrency = (amount, currency) => {
            const options = { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 };
            return new Intl.NumberFormat(currency === 'KRW' ? 'ko-KR' : 'zh-CN', options).format(amount);
        };

        const formatCompactNumber = (number) => {
            if (number === 0) return '0';
            const abs = Math.abs(number);
            if (abs < 1000) return new Intl.NumberFormat('ko-KR').format(number);
            if (abs < 10000) {
                 const val = number / 1000;
                 return val.toFixed(val % 1 === 0 ? 0 : 1) + '천';
            }
            const val = number / 10000;
            return val.toFixed(val % 1 === 0 ? 0 : 1) + '만';
        };

        const generateCalendarDays = (year, month) => {
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = lastDayOfMonth.getDate();
            const days = [];
            for (let i = 0; i < startDayOfWeek; i++) days.push({ day: null, dateStr: null });
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                days.push({ day: i, dateStr: dateStr });
            }
            return days;
        };

        const DEFAULT_CATEGORIES = {
            income: ['급여', '용돈', '상여금', '금융수입', '기타'],
            expense: ['식비', '교통', '문화', '공과금', '쇼핑', '주거', '의료', '기타']
        };
        const DEFAULT_MAIN_CATEGORIES = {
            income: ['근로소득', '금융소득', '기타'],
            expense: ['고정지출', '변동지출', '저축', '기타']
        };

        function App() {
            const [isLoaded, setIsLoaded] = useState(false);
            const [initialBalance, setInitialBalance] = useState(0);
            const [currency, setCurrency] = useState('KRW'); 
            const [isDarkMode, setIsDarkMode] = useState(true); 
            const [fontIndex, setFontIndex] = useState(2); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('calendar');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [transactions, setTransactions] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [mainCategories, setMainCategories] = useState(DEFAULT_MAIN_CATEGORIES);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedDateDetail, setSelectedDateDetail] = useState(null); 
            const [settingsTab, setSettingsTab] = useState('general');
            const [newCategoryName, setNewCategoryName] = useState('');
            const [categoryTypeToAdd, setCategoryTypeToAdd] = useState('expense');
            const [newTrans, setNewTrans] = useState({
                date: new Date().toISOString().split('T')[0],
                type: 'expense',
                mainCategory: '', 
                category: '',
                amount: '',
                desc: '',
                memo: '' 
            });

            useEffect(() => {
                const savedData = localStorage.getItem('bk_budget_data_v21');
                const savedFontIndex = localStorage.getItem('bk_budget_font_idx');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                        if (parsed.currency) setCurrency(parsed.currency);
                        if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                        if (parsed.transactions) setTransactions(parsed.transactions);
                        if (parsed.categories) setCategories(parsed.categories);
                        if (parsed.mainCategories) setMainCategories(parsed.mainCategories);
                    } catch (e) { console.error(e); }
                } else {
                    const oldData = localStorage.getItem('bk_budget_data_v5');
                    if (oldData) {
                        try {
                            const parsed = JSON.parse(oldData);
                            if (parsed.transactions) setTransactions(parsed.transactions);
                            if (parsed.initialBalance) setInitialBalance(parsed.initialBalance);
                            if (parsed.categories) setCategories(parsed.categories);
                        } catch(e) {}
                    }
                }
                if (savedFontIndex !== null) {
                    const idx = parseInt(savedFontIndex, 10);
                    if (idx >= 0 && idx < FONT_SIZES.length) setFontIndex(idx);
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories, mainCategories };
                    localStorage.setItem('bk_budget_data_v21', JSON.stringify(dataToSave)); 
                }
            }, [initialBalance, currency, isDarkMode, transactions, categories, mainCategories, isLoaded]);

            const handleFontUp = () => { const newIndex = Math.min(fontIndex + 1, FONT_SIZES.length - 1); setFontIndex(newIndex); localStorage.setItem('bk_budget_font_idx', newIndex); };
            const handleFontDown = () => { const newIndex = Math.max(fontIndex - 1, 0); setFontIndex(newIndex); localStorage.setItem('bk_budget_font_idx', newIndex); };

            useEffect(() => {
                if (isModalOpen && !editingId) {
                    const currentMainCats = newTrans.type === 'income' ? mainCategories.income : mainCategories.expense;
                    const currentSubCats = newTrans.type === 'income' ? categories.income : categories.expense;
                    setNewTrans(prev => ({ 
                        ...prev, 
                        mainCategory: currentMainCats.length > 0 ? currentMainCats[0] : '',
                        category: currentSubCats.length > 0 ? currentSubCats[0] : ''
                    }));
                }
            }, [newTrans.type, categories, mainCategories, isModalOpen, editingId]);

            const handleExport = () => {
                const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories, mainCategories, exportDate: new Date().toISOString(), version: APP_VERSION };
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `BK_Budget_${APP_VERSION}_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if (window.confirm("복원하시겠습니까?")) {
                            if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                            if (parsed.currency) setCurrency(parsed.currency);
                            if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                            if (parsed.transactions) setTransactions(parsed.transactions);
                            if (parsed.categories) setCategories(parsed.categories);
                            if (parsed.mainCategories) setMainCategories(parsed.mainCategories);
                            alert("복원 완료");
                            setIsSettingsOpen(false);
                        }
                    } catch (err) { alert("파일 오류"); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); 
            const sortedTransactions = useMemo(() => [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date)), [transactions]);

            const dailyStatsMap = useMemo(() => {
                const stats = {};
                let runningBalance = Number(initialBalance); 
                sortedTransactions.forEach(t => {
                    const dateKey = t.date;
                    if (!stats[dateKey]) stats[dateKey] = { income: 0, expense: 0, balance: 0 };
                    if (t.type === 'income') { stats[dateKey].income += Number(t.amount); runningBalance += Number(t.amount); }
                    else { stats[dateKey].expense += Number(t.amount); runningBalance -= Number(t.amount); }
                    stats[dateKey].balance = runningBalance;
                });
                return { stats, finalBalance: runningBalance };
            }, [sortedTransactions, initialBalance]);

            const allTimeStats = useMemo(() => {
                let income = 0;
                let expense = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') income += Number(t.amount);
                    else expense += Number(t.amount);
                });
                const balance = Number(initialBalance) + income - expense;
                return { income, expense, balance };
            }, [transactions, initialBalance]);

            const yearlyStats = useMemo(() => {
                const monthlyData = Array(12).fill(null).map((_, i) => ({ month: i + 1, income: 0, expense: 0, balance: 0, carryover: 0, totalRevenue: 0 }));
                const hierarchyData = { income: {}, expense: {} };

                const yearTransactions = transactions.filter(t => t.date.startsWith(String(year)));
                
                yearTransactions.forEach(t => {
                    const m = new Date(t.date).getMonth(); 
                    const mainCat = t.mainCategory || '기타';
                    const subCat = t.category || '기타';
                    const amt = Number(t.amount);
                    const type = t.type; 

                    if (type === 'income') monthlyData[m].income += amt;
                    else monthlyData[m].expense += amt;

                    if (!hierarchyData[type][mainCat]) {
                        hierarchyData[type][mainCat] = { total: 0, monthly: Array(12).fill(0), subs: {} };
                    }
                    hierarchyData[type][mainCat].total += amt;
                    hierarchyData[type][mainCat].monthly[m] += amt;

                    if (!hierarchyData[type][mainCat].subs[subCat]) {
                        hierarchyData[type][mainCat].subs[subCat] = { total: 0, monthly: Array(12).fill(0) };
                    }
                    hierarchyData[type][mainCat].subs[subCat].total += amt;
                    hierarchyData[type][mainCat].subs[subCat].monthly[m] += amt;
                });

                let currentCarryover = Number(initialBalance);
                const prevYearTrans = transactions.filter(t => new Date(t.date).getFullYear() < year);
                prevYearTrans.forEach(t => {
                    if(t.type === 'income') currentCarryover += Number(t.amount);
                    else currentCarryover -= Number(t.amount);
                });

                monthlyData.forEach(s => {
                    s.carryover = currentCarryover; 
                    s.totalRevenue = s.carryover + s.income; 
                    s.balance = s.totalRevenue - s.expense; 
                    currentCarryover = s.balance;
                });

                return { monthlyData, hierarchyData }; 
            }, [transactions, year, initialBalance]);

            const categoryStats = useMemo(() => {
                const startStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endStr = `${year}-${String(month + 1).padStart(2, '0')}-31`;
                let carryover = Number(initialBalance);
                transactions.forEach(t => {
                    if (t.date < startStr) {
                        if (t.type === 'income') carryover += Number(t.amount);
                        else carryover -= Number(t.amount);
                    }
                });

                const currentMonthTrans = transactions.filter(t => t.date >= startStr && t.date <= endStr);
                const prevMonthTrans = transactions.filter(t => {
                    const prevDate = new Date(year, month - 1, 1);
                    const prevStart = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}-01`;
                    const prevEnd = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}-31`;
                    return t.date >= prevStart && t.date <= prevEnd;
                });

                const hierarchy = { income: {}, expense: {} };

                const processTrans = (transList, isPrev) => {
                    transList.forEach(t => {
                        const type = t.type;
                        const mainCat = t.mainCategory || '기타';
                        const subCat = t.category || '기타';
                        const amt = Number(t.amount);

                        if (!hierarchy[type][mainCat]) hierarchy[type][mainCat] = { total: 0, prev: 0, subs: {} };
                        if (isPrev) hierarchy[type][mainCat].prev += amt;
                        else hierarchy[type][mainCat].total += amt;

                        if (!hierarchy[type][mainCat].subs[subCat]) hierarchy[type][mainCat].subs[subCat] = { total: 0, prev: 0 };
                        if (isPrev) hierarchy[type][mainCat].subs[subCat].prev += amt;
                        else hierarchy[type][mainCat].subs[subCat].total += amt;
                    });
                };

                processTrans(currentMonthTrans, false);
                processTrans(prevMonthTrans, true);

                const sortHierarchy = (data) => {
                    return Object.entries(data).map(([key, val]) => {
                        const sortedSubs = Object.entries(val.subs).map(([subKey, subVal]) => ({ name: subKey, ...subVal })).sort((a, b) => b.total - a.total);
                        return { name: key, ...val, subs: sortedSubs };
                    }).sort((a, b) => b.total - a.total);
                };

                const monthlyIncome = currentMonthTrans.filter(t => t.type === 'income').reduce((a, b) => a + Number(b.amount), 0);
                const monthlyExpense = currentMonthTrans.filter(t => t.type === 'expense').reduce((a, b) => a + Number(b.amount), 0);
                const totalRevenue = carryover + monthlyIncome;
                const finalBalance = totalRevenue - monthlyExpense;

                return {
                    income: sortHierarchy(hierarchy.income),
                    expense: sortHierarchy(hierarchy.expense),
                    monthlyIncome, monthlyExpense, carryover, totalRevenue, finalBalance 
                };
            }, [transactions, year, month, initialBalance]);

            const getBalanceAtDate = (targetDateStr) => {
                let balance = Number(initialBalance); 
                for (const t of sortedTransactions) {
                    if (t.date > targetDateStr) break;
                    if (t.type === 'income') balance += Number(t.amount);
                    else balance -= Number(t.amount);
                }
                return balance;
            };

            const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const handleNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
            
            const handleSaveTransaction = (e) => {
                e.preventDefault();
                if (!newTrans.amount || !newTrans.desc) return;
                const currentMainCats = newTrans.type === 'income' ? mainCategories.income : mainCategories.expense;
                const currentSubCats = newTrans.type === 'income' ? categories.income : categories.expense;
                const transToSave = { 
                    ...newTrans, 
                    mainCategory: newTrans.mainCategory || (currentMainCats[0] || '기타'),
                    category: newTrans.category || (currentSubCats[0] || '기타'),
                    amount: Number(newTrans.amount) 
                };
                if (editingId) setTransactions(prev => prev.map(t => t.id === editingId ? { ...transToSave, id: editingId } : t));
                else setTransactions([...transactions, { id: Date.now(), ...transToSave }]);
                setIsModalOpen(false); setEditingId(null); setNewTrans({ ...newTrans, amount: '', desc: '', category: '', mainCategory: '', memo: '' }); setSelectedDateDetail(null);
            };

            const handleEditClick = (transaction) => {
                setEditingId(transaction.id);
                setNewTrans({ date: transaction.date, type: transaction.type, amount: transaction.amount, desc: transaction.desc, category: transaction.category || '', mainCategory: transaction.mainCategory || '', memo: transaction.memo || '' });
                setIsModalOpen(true); setSelectedDateDetail(null);
            };

            const handleDelete = (id) => {
                if (window.confirm("삭제하시겠습니까?")) {
                    setTransactions(transactions.filter(t => t.id !== id));
                    if (selectedDateDetail) setSelectedDateDetail(prev => ({ ...prev, items: prev.items.filter(i => i.id !== id) }));
                }
            };

            const handleDateClick = (dateStr) => {
                if (!dateStr) return;
                const dayTrans = transactions.filter(t => t.date === dateStr);
                setSelectedDateDetail({ dateStr, items: dayTrans });
            };

            const handleAddCategory = (isMain) => {
                if (!newCategoryName.trim()) return;
                const type = categoryTypeToAdd;
                const targetState = isMain ? mainCategories : categories;
                const setTargetState = isMain ? setMainCategories : setCategories;
                if (targetState[type].includes(newCategoryName)) { alert('이미 존재함'); return; }
                setTargetState(prev => ({ ...prev, [type]: [...prev[type], newCategoryName] }));
                setNewCategoryName('');
            };

            const handleDeleteCategory = (isMain, type, name) => {
                const targetState = isMain ? mainCategories : categories;
                const setTargetState = isMain ? setMainCategories : setCategories;
                if (targetState[type].length <= 1) { alert('최소 1개 필수'); return; }
                if (window.confirm('삭제하시겠습니까?')) {
                    setTargetState(prev => ({ ...prev, [type]: prev[type].filter(c => c !== name) }));
                }
            };

            const calendarDays = generateCalendarDays(year, month);
            
            const theme = {
                bg: isDarkMode ? 'bg-black' : 'bg-gray-50',
                text: isDarkMode ? 'text-gray-100' : 'text-gray-800',
                card: isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-200',
                cardText: isDarkMode ? 'text-gray-200' : 'text-gray-900',
                subText: isDarkMode ? 'text-gray-400' : 'text-gray-500',
                border: isDarkMode ? 'border-neutral-800' : 'border-gray-200',
                hover: isDarkMode ? 'hover:bg-neutral-800' : 'hover:bg-gray-50',
                input: isDarkMode ? 'bg-neutral-800 border-neutral-700 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-900',
                header: isDarkMode ? 'bg-black border-neutral-800' : 'bg-white border-gray-200',
                th: isDarkMode ? 'bg-neutral-900 text-gray-400' : 'bg-gray-50 text-gray-600',
                gridLine: isDarkMode ? 'border-neutral-800' : 'border-gray-100',
                today: isDarkMode ? 'bg-indigo-900/40' : 'bg-indigo-50/30',
                incomeText: isDarkMode ? 'text-blue-400' : 'text-blue-600',
                incomeBg: isDarkMode ? 'bg-blue-500/20' : 'bg-blue-100',
                expenseText: isDarkMode ? 'text-rose-400' : 'text-rose-600',
                expenseBg: isDarkMode ? 'bg-rose-500/20' : 'bg-red-100',
            };

            if (!isLoaded) return null; 

            const renderComparison = (currentVal, category, type) => {
                // 통계 탭 비교 기능은 현재 버전에서 간소화
                return null;
            };

            const currentFontSizeClass = FONT_SIZES[fontIndex];
            const currentTableFontSize = TABLE_FONT_SIZES[fontIndex];

            const renderCategoryManager = (isMain) => {
                const targetState = isMain ? mainCategories : categories;
                return (
                    <div className="space-y-4">
                        <div className="flex gap-2 p-1 bg-neutral-800 rounded mb-2">
                            <button onClick={() => setCategoryTypeToAdd('income')} className={`flex-1 py-1.5 text-xs rounded ${categoryTypeToAdd === 'income' ? 'bg-blue-600 text-white' : 'text-gray-400'}`}>수입 {isMain ? '대항목' : '소항목'}</button>
                            <button onClick={() => setCategoryTypeToAdd('expense')} className={`flex-1 py-1.5 text-xs rounded ${categoryTypeToAdd === 'expense' ? 'bg-rose-600 text-white' : 'text-gray-400'}`}>지출 {isMain ? '대항목' : '소항목'}</button>
                        </div>
                        <div className="flex gap-2">
                            <input type="text" value={newCategoryName} onChange={(e) => setNewCategoryName(e.target.value)} placeholder="새 항목 이름" className={`flex-1 rounded border px-3 py-2 text-sm ${theme.input}`} />
                            <button onClick={() => handleAddCategory(isMain)} className="bg-blue-600 text-white px-3 py-2 rounded text-sm shrink-0">추가</button>
                        </div>
                        <div className="space-y-2 max-h-[200px] overflow-y-auto pr-1">
                            {targetState[categoryTypeToAdd].map(cat => (
                                <div key={cat} className={`flex justify-between items-center p-2 rounded border ${theme.border} ${theme.bg}`}>
                                    <span className={`text-sm ${theme.cardText}`}>{cat}</span>
                                    <button onClick={() => handleDeleteCategory(isMain, categoryTypeToAdd, cat)} className="text-gray-500 hover:text-red-500"><Trash2 size={14} /></button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen font-sans transition-colors duration-200 ${theme.bg} ${theme.text} overflow-x-hidden ${currentFontSizeClass} text-transition`}>
                    <header className={`sticky top-0 z-50 border-b ${theme.header}`}>
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-2 rounded-lg text-white"><CalendarIcon size={20} /></div>
                                <div className="flex items-end gap-1">
                                    <h1 className={`text-xl font-bold tracking-tight ${theme.cardText}`}>BK</h1>
                                    <span className={`text-xs font-mono mb-1 ${theme.subText}`}>{APP_VERSION}</span>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="flex items-center bg-neutral-800 rounded-lg p-0.5 mr-2">
                                    <button onClick={handleFontDown} className="p-1.5 text-gray-400 hover:text-white"><Minus size={14}/></button>
                                    <span className="text-[10px] w-8 text-center text-gray-300 font-mono">{FONT_LABELS[fontIndex]}</span>
                                    <button onClick={handleFontUp} className="p-1.5 text-gray-400 hover:text-white"><Plus size={14}/></button>
                                </div>
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full ${theme.hover} ${theme.subText}`}><Sun size={20} /></button>
                                <button onClick={() => { setIsSettingsOpen(true); setSettingsTab('general'); }} className={`p-2 rounded-full ${theme.hover} ${theme.subText}`}><Settings size={20} /></button>
                                <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className="ml-2 bg-blue-600 text-white px-3 py-2 rounded-md"><Plus size={16} /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-6 pb-20">
                        {/* 1. 상단 대시보드 */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className={`md:col-span-1 rounded-xl border p-4 flex flex-col justify-center gap-2 relative overflow-hidden ${theme.card}`}>
                                <div className="flex justify-between items-center text-[0.9em] border-b border-neutral-800 pb-2 mb-1">
                                    <span className={theme.subText}>전월 이월</span>
                                    <span className={theme.cardText}>{formatCurrency(categoryStats.carryover, currency)}</span>
                                </div>
                                <div className="flex justify-between items-center text-[0.9em]">
                                    <span className="text-blue-400 font-medium">이번 달 수입</span>
                                    <span className="text-blue-400 font-bold">+{formatCurrency(categoryStats.monthlyIncome, currency)}</span>
                                </div>
                                <div className="flex justify-between items-center pt-2 mt-1 border-t border-neutral-700">
                                    <span className="text-[0.8em] text-gray-400">총 가용 자금</span>
                                    <span className={`text-[1.2em] font-bold ${theme.cardText}`}>{formatCurrency(categoryStats.totalRevenue, currency)}</span>
                                </div>
                            </div>

                            <div className={`md:col-span-1 rounded-xl border p-4 flex flex-col justify-center items-center gap-1 relative overflow-hidden ${isDarkMode ? 'bg-rose-900/10 border-rose-800/30' : 'bg-rose-50 border-rose-200'}`}>
                                <TrendingDown size={24} className="text-rose-500 mb-1"/>
                                <span className={theme.subText}>이번 달 총 지출</span>
                                <span className="text-[1.5em] font-bold text-rose-500">{formatCurrency(categoryStats.monthlyExpense, currency)}</span>
                            </div>

                            <div className={`md:col-span-1 rounded-xl border p-4 flex flex-col justify-center items-center gap-1 relative overflow-hidden ${isDarkMode ? 'bg-blue-900/10 border-blue-800/30' : 'bg-blue-50 border-blue-200'}`}>
                                <Wallet size={24} className="text-blue-500 mb-1"/>
                                <span className={theme.subText}>최종 월 잔액</span>
                                <span className={`text-[1.5em] font-bold ${categoryStats.finalBalance >= 0 ? 'text-blue-500' : 'text-rose-500'}`}>
                                    {formatCurrency(categoryStats.finalBalance, currency)}
                                </span>
                            </div>
                        </div>
                        
                         <div className={`rounded-xl border p-3 mb-6 flex justify-between items-center ${theme.card}`}>
                            <div className="flex items-center gap-2"><Layers size={16} className="text-gray-400"/><span className={`text-xs ${theme.subText}`}>전체 누적 자산</span></div>
                            <span className={`font-bold ${allTimeStats.balance >= 0 ? 'text-blue-400' : 'text-rose-400'}`}>{formatCurrency(allTimeStats.balance, currency)}</span>
                        </div>

                        {/* 탭 메뉴 */}
                        <div className="flex gap-2 mb-4 border-b border-gray-200 dark:border-neutral-800">
                            <button onClick={() => setActiveTab('calendar')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 ${activeTab === 'calendar' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><LayoutGrid size={18} />달력</button>
                            <button onClick={() => setActiveTab('list')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 ${activeTab === 'list' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><List size={18} />목록</button>
                            <button onClick={() => setActiveTab('stats')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 ${activeTab === 'stats' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><BarChart3 size={18} />통계</button>
                            <button onClick={() => setActiveTab('yearly')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 ${activeTab === 'yearly' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><Table2 size={18} />연간</button>
                        </div>

                        {/* 캘린더 뷰 */}
                        {activeTab === 'calendar' && (
                            <div className={`rounded-xl shadow border overflow-hidden ${theme.card}`}>
                                <div className="flex justify-between items-center p-4 border-b border-neutral-800">
                                    <button onClick={handlePrevMonth} className={`p-1 rounded ${theme.hover}`}><ChevronLeft size={20}/></button>
                                    <span className={`font-bold ${theme.cardText}`}>{year}년 {month + 1}월</span>
                                    <button onClick={handleNextMonth} className={`p-1 rounded ${theme.hover}`}><ChevronRight size={20}/></button>
                                </div>
                                <div className={`grid grid-cols-7 border-b ${theme.border} ${theme.th}`}>
                                    {['일', '월', '화', '수', '목', '금', '토'].map((day, idx) => (<div key={day} className={`py-3 text-center font-semibold ${idx === 0 ? 'text-red-500' : idx === 6 ? 'text-blue-500' : ''}`}>{day}</div>))}
                                </div>
                                <div className="grid grid-cols-7 auto-rows-fr">
                                    {calendarDays.map((item, idx) => {
                                        if (!item.day) return <div key={`empty-${idx}`} className={`min-h-[100px] sm:min-h-[140px] p-1 border-b border-r last:border-r-0 relative cursor-pointer ${theme.gridLine} ${theme.hover} ${isToday ? theme.today : ''}`}></div>;
                                        const dateStats = dailyStatsMap.stats[item.dateStr];
                                        const currentBalance = dateStats ? dateStats.balance : getBalanceAtDate(item.dateStr);
                                        const isToday = item.dateStr === new Date().toISOString().split('T')[0];
                                        const dayTransactions = transactions.filter(t => t.date === item.dateStr);

                                        return (
                                            <div key={item.dateStr} onClick={() => handleDateClick(item.dateStr)} className={`min-h-[100px] sm:min-h-[140px] p-1 border-b border-r last:border-r-0 relative cursor-pointer ${theme.gridLine} ${theme.hover} ${isToday ? theme.today : ''}`}>
                                                <div className="flex flex-col h-full justify-start gap-1">
                                                    {/* 상단: 날짜 + 요약 */}
                                                    <div className="flex flex-col sm:flex-row justify-between items-start w-full gap-1 flex-shrink-0">
                                                        <span className={`text-[0.8em] font-medium w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : theme.subText}`}>{item.day}</span>
                                                        
                                                        <div className="flex flex-row flex-wrap justify-end gap-x-1.5 gap-y-0.5 items-baseline w-full">
                                                            {dateStats?.income > 0 && <span className="text-[0.65em] text-blue-400">+{formatCompactNumber(dateStats.income)}</span>}
                                                            {dateStats?.expense > 0 && <span className="text-[0.65em] text-rose-400">-{formatCompactNumber(dateStats.expense)}</span>}
                                                            <span className={`text-[0.65em] ${currentBalance < 0 ? 'text-rose-500 font-bold' : 'text-white'}`}>{formatCompactNumber(currentBalance)}</span>
                                                        </div>
                                                    </div>

                                                    {/* 하단: 거래 리스트 (소항목 + 내용) */}
                                                    <div className="flex flex-col gap-0.5 overflow-y-auto scrollbar-hide flex-grow max-h-[80px]">
                                                        {dayTransactions.map((t) => (
                                                            <div key={t.id} className={`text-[0.7em] flex justify-between items-center px-1 py-0.5 rounded ${t.type === 'income' ? `${theme.incomeBg} ${theme.incomeText}` : `${theme.expenseBg} ${theme.expenseText}`}`}>
                                                                <div className="flex items-center gap-1 truncate max-w-[65%]">
                                                                    {/* [복구] 소항목(Category) 태그 추가 */}
                                                                    <span className="opacity-75 border px-0.5 rounded border-current shrink-0 text-[0.9em]">
                                                                        {t.category}
                                                                    </span>
                                                                    <span className="truncate">{t.desc}</span>
                                                                </div>
                                                                <span>{formatCompactNumber(t.amount)}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* 리스트, 통계, 연간 뷰 생략 (이전 버전과 동일하게 유지) */}
                        {activeTab === 'list' && (
                            <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                <div className="space-y-3">
                                    {transactions.filter(t => t.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)).sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => (
                                        <div key={t.id} className={`flex justify-between items-center p-3 rounded border ${theme.border} ${theme.bg}`}>
                                            <div>
                                                <p className={`text-[0.8em] ${theme.subText} mb-0.5`}>{t.date}</p>
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-[0.8em] px-1.5 py-0.5 rounded border border-neutral-700 text-neutral-400`}>{t.mainCategory || '기타'}</span>
                                                    <span className={`text-[0.8em] px-1.5 py-0.5 rounded border ${t.type === 'income' ? 'border-blue-500 text-blue-500' : 'border-rose-500 text-rose-500'}`}>{t.category}</span>
                                                </div>
                                                {t.memo && <p className="text-[0.8em] text-gray-500 mt-1 flex items-center gap-1"><StickyNote size={10}/> {t.memo}</p>}
                                                <p className={`font-medium ${theme.cardText}`}>{t.desc}</p>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className={`font-bold ${t.type === 'income' ? theme.incomeText : theme.expenseText}`}>{t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount, currency)}</span>
                                                <div className="flex gap-2"><button onClick={() => handleEditClick(t)} className="text-gray-400"><Pencil size={16}/></button><button onClick={() => handleDelete(t.id)} className="text-gray-400"><X size={16}/></button></div>
                                            </div>
                                        </div>
                                    ))}
                                    {transactions.filter(t => t.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)).length === 0 && <div className={`text-center py-10 ${theme.subText}`}>내역 없음</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6 animate-in fade-in zoom-in duration-200">
                                <div className={`rounded-xl shadow border p-5 ${theme.card}`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className={`font-bold flex items-center gap-2 ${theme.cardText}`}><Scale size={18} className="text-gray-400"/>이번 달 수지</h3>
                                        <span className={`text-lg font-bold ${categoryStats.finalBalance >= 0 ? theme.incomeText : theme.expenseText}`}>{formatCurrency(categoryStats.finalBalance, currency)}</span>
                                    </div>
                                    <div className="relative h-4 bg-neutral-800 rounded-full overflow-hidden mb-2">
                                        <div className="absolute left-0 top-0 h-full bg-blue-500" style={{ width: `${categoryStats.totalRevenue > 0 ? (categoryStats.totalRevenue / (categoryStats.totalRevenue + categoryStats.monthlyExpense)) * 100 : 0}%` }}></div>
                                        <div className="absolute right-0 top-0 h-full bg-rose-500" style={{ width: `${categoryStats.monthlyExpense > 0 ? (categoryStats.monthlyExpense / (categoryStats.totalRevenue + categoryStats.monthlyExpense)) * 100 : 0}%` }}></div>
                                    </div>
                                    <div className="flex justify-between text-[0.8em]">
                                        <span className="text-blue-500">가용(총수입) {formatCurrency(categoryStats.totalRevenue, currency)}</span>
                                        <span className="text-rose-500">지출 {formatCurrency(categoryStats.monthlyExpense, currency)}</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                        <h3 className={`font-bold mb-4 flex items-center gap-2 ${theme.cardText}`}><TrendingDown size={18} className="text-rose-500"/>지출 분석</h3>
                                        <div className="space-y-4">
                                            {categoryStats.expense.map((main) => (
                                                <div key={main.name} className="space-y-2">
                                                    <div className="flex justify-between items-end border-b border-neutral-800 pb-1">
                                                        <span className={`font-bold ${theme.cardText}`}>{main.name}</span>
                                                        <div className="flex gap-2 items-end">
                                                            {renderComparison(main.total, main.prev, 'expense')}
                                                            <span className={`${theme.expenseText} font-bold`}>{formatCurrency(main.total, currency)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1.5 pl-2 border-l-2 border-neutral-800 ml-1">
                                                        {main.subs.map((sub) => (
                                                            <div key={sub.name}>
                                                                <div className="flex justify-between items-end text-[0.9em]">
                                                                    <span className={theme.subText}>{sub.name}</span>
                                                                    <span className={theme.cardText}>{formatCurrency(sub.total, currency)}</span>
                                                                </div>
                                                                <div className="w-full bg-neutral-800 rounded-full h-1.5 overflow-hidden mt-0.5">
                                                                    <div className="bg-rose-500/50 h-1.5 rounded-full" style={{ width: `${main.total > 0 ? (sub.total / main.total) * 100 : 0}%` }}></div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                            {categoryStats.expense.length === 0 && <p className={`text-center py-4 ${theme.subText}`}>지출 내역이 없습니다.</p>}
                                        </div>
                                    </div>

                                    <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                        <h3 className={`font-bold mb-4 flex items-center gap-2 ${theme.cardText}`}><TrendingUp size={18} className="text-blue-500"/>수입 분석</h3>
                                        <div className="space-y-4">
                                            {categoryStats.income.map((main) => (
                                                <div key={main.name} className="space-y-2">
                                                    <div className="flex justify-between items-end border-b border-neutral-800 pb-1">
                                                        <span className={`font-bold ${theme.cardText}`}>{main.name}</span>
                                                        <div className="flex gap-2 items-end">
                                                            {renderComparison(main.total, main.prev, 'income')}
                                                            <span className={`${theme.incomeText} font-bold`}>{formatCurrency(main.total, currency)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1.5 pl-2 border-l-2 border-neutral-800 ml-1">
                                                        {main.subs.map((sub) => (
                                                            <div key={sub.name}>
                                                                <div className="flex justify-between items-end text-[0.9em]">
                                                                    <span className={theme.subText}>{sub.name}</span>
                                                                    <span className={theme.cardText}>{formatCurrency(sub.total, currency)}</span>
                                                                </div>
                                                                <div className="w-full bg-neutral-800 rounded-full h-1.5 overflow-hidden mt-0.5">
                                                                    <div className="bg-blue-500/50 h-1.5 rounded-full" style={{ width: `${main.total > 0 ? (sub.total / main.total) * 100 : 0}%` }}></div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                            {categoryStats.income.length === 0 && <p className={`text-center py-4 ${theme.subText}`}>수입 내역이 없습니다.</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'yearly' && (
                            <div className={`rounded-xl shadow border p-2 animate-in fade-in zoom-in duration-200 ${theme.card}`}>
                                <div className="flex justify-between items-center mb-4 px-2">
                                    <h3 className={`font-bold flex items-center gap-2 ${theme.cardText}`}>
                                        <Table2 size={18} className="text-gray-400"/>
                                        {year}년 계층형 흐름
                                    </h3>
                                    <span className={`text-[0.9em] ${theme.subText}`}>1월 - 12월</span>
                                </div>
                                <div className="overflow-x-auto border border-neutral-800 rounded-lg">
                                    <table className={`w-full ${currentTableFontSize} text-left table-fixed`}>
                                        <thead className={`bg-neutral-900 ${theme.subText}`}>
                                            <tr>
                                                <th className="px-1 py-2 border-r border-neutral-800 font-bold text-gray-300 w-[60px] max-w-[60px] whitespace-nowrap overflow-hidden text-ellipsis">구분</th>
                                                {[...Array(12)].map((_, i) => <th key={i} className="px-0.5 py-2 text-center border-r border-neutral-800 last:border-0 w-[6%]">{i+1}</th>)}
                                                <th className="px-1 py-2 text-right bg-neutral-900 border-l border-neutral-800 font-bold text-gray-300 w-[13%]">합계</th>
                                            </tr>
                                        </thead>
                                        <tbody className={`divide-y divide-neutral-800 ${theme.cardText}`}>
                                            <tr className="bg-neutral-800/80 font-bold">
                                                <td className="px-1 py-2 border-r border-neutral-700 text-gray-400 truncate">전월 이월</td>
                                                {yearlyStats.monthlyData.map((stat, i) => (
                                                    <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-gray-400 truncate">{formatCompactNumber(stat.carryover)}</td>
                                                ))}
                                                <td className="px-1 py-2 text-right border-l border-neutral-700 text-gray-400">-</td>
                                            </tr>
                                            <tr className="bg-neutral-800/50 font-bold">
                                                <td className="px-1 py-2 border-r border-neutral-700 text-blue-400 truncate">월 수입</td>
                                                {yearlyStats.monthlyData.map((stat, i) => (
                                                    <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-blue-400 truncate">{formatCompactNumber(stat.income)}</td>
                                                ))}
                                                <td className="px-1 py-2 text-right border-l border-neutral-700 text-blue-400 truncate">
                                                    {formatCompactNumber(yearlyStats.monthlyData.reduce((a, b) => a + b.income, 0))}
                                                </td>
                                            </tr>
                                            <tr className="bg-neutral-800/50 font-bold">
                                                <td className="px-1 py-2 border-r border-neutral-700 text-rose-400 truncate">월 지출</td>
                                                {yearlyStats.monthlyData.map((stat, i) => (
                                                    <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-rose-400 truncate">{formatCompactNumber(stat.expense)}</td>
                                                ))}
                                                <td className="px-1 py-2 text-right border-l border-neutral-700 text-rose-400 truncate">
                                                    {formatCompactNumber(yearlyStats.monthlyData.reduce((a, b) => a + b.expense, 0))}
                                                </td>
                                            </tr>
                                            <tr className="bg-neutral-800/80 font-bold border-b-2 border-neutral-700">
                                                <td className="px-1 py-2 border-r border-neutral-700 text-white truncate">월 잔액</td>
                                                {yearlyStats.monthlyData.map((stat, i) => (
                                                    <td key={i} className={`px-0.5 py-2 text-right border-r border-neutral-800 truncate ${stat.balance >= 0 ? 'text-blue-300' : 'text-rose-300'}`}>
                                                        {formatCompactNumber(stat.balance)}
                                                    </td>
                                                ))}
                                                <td className="px-1 py-2 text-right border-l border-neutral-700 text-white truncate">
                                                    {formatCompactNumber(yearlyStats.monthlyData.reduce((a, b) => a + b.balance, 0))}
                                                </td>
                                            </tr>
                                            <tr className="bg-blue-900/30 font-bold border-b border-blue-900"><td colSpan="14" className="px-1 py-2 text-blue-400 truncate pl-2">수입 내역</td></tr>
                                            {Object.entries(yearlyStats.hierarchyData.income).map(([mainCat, data]) => (
                                                <React.Fragment key={mainCat}>
                                                    <tr className="bg-neutral-800/30 font-bold">
                                                        <td className="px-1 py-2 border-r border-neutral-800 text-blue-200 pl-2 border-l-2 border-l-blue-500 truncate">{mainCat}</td>
                                                        {data.monthly.map((amt, i) => (
                                                            <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-blue-200 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>
                                                        ))}
                                                        <td className="px-1 py-2 text-right border-l border-neutral-800 text-blue-200 truncate">{formatCompactNumber(data.total)}</td>
                                                    </tr>
                                                    {Object.entries(data.subs).map(([subCat, subData]) => (
                                                        <tr key={`${mainCat}-${subCat}`} className="hover:bg-neutral-800/50 text-neutral-400">
                                                            <td className="px-1 py-1.5 border-r border-neutral-800 pl-4 truncate">{subCat}</td>
                                                            {subData.monthly.map((amt, i) => (
                                                                <td key={i} className="px-0.5 py-1.5 text-right border-r border-neutral-800 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>
                                                            ))}
                                                            <td className="px-1 py-1.5 text-right border-l border-neutral-800 truncate">{formatCompactNumber(subData.total)}</td>
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                            <tr className="bg-rose-900/30 font-bold border-b border-rose-900"><td colSpan="14" className="px-1 py-2 text-rose-400 truncate pl-2">지출 내역</td></tr>
                                            {Object.entries(yearlyStats.hierarchyData.expense).map(([mainCat, data]) => (
                                                <React.Fragment key={mainCat}>
                                                    <tr className="bg-neutral-800/30 font-bold">
                                                        <td className="px-1 py-2 border-r border-neutral-800 text-rose-200 pl-2 border-l-2 border-l-rose-500 truncate">{mainCat}</td>
                                                        {data.monthly.map((amt, i) => (
                                                            <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-rose-200 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>
                                                        ))}
                                                        <td className="px-1 py-2 text-right border-l border-neutral-800 text-rose-200 truncate">{formatCompactNumber(data.total)}</td>
                                                    </tr>
                                                    {Object.entries(data.subs).map(([subCat, subData]) => (
                                                        <tr key={`${mainCat}-${subCat}`} className="hover:bg-neutral-800/50 text-neutral-400">
                                                            <td className="px-1 py-1.5 border-r border-neutral-800 pl-4 truncate">{subCat}</td>
                                                            {subData.monthly.map((amt, i) => (
                                                                <td key={i} className="px-0.5 py-1.5 text-right border-r border-neutral-800 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>
                                                            ))}
                                                            <td className="px-1 py-1.5 text-right border-l border-neutral-800 truncate">{formatCompactNumber(subData.total)}</td>
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    {selectedDateDetail && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={() => setSelectedDateDetail(null)}>
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden ${theme.card}`} onClick={e => e.stopPropagation()}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>{selectedDateDetail.dateStr}</h3><button onClick={() => setSelectedDateDetail(null)} className={theme.subText}><X size={20} /></button></div>
                                <div className="max-h-[50vh] overflow-y-auto p-2 space-y-2">
                                    {selectedDateDetail.items.map(t => (
                                        <div key={t.id} className={`flex justify-between items-center p-3 rounded border ${theme.border} ${theme.bg}`}>
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded border border-neutral-700 text-neutral-400`}>{t.mainCategory || '기타'}</span>
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded border ${t.type === 'income' ? 'border-blue-500 text-blue-500' : 'border-rose-500 text-rose-500'}`}>{t.category}</span>
                                                </div>
                                                <p className={`font-medium ${theme.cardText}`}>{t.desc}</p>
                                                {t.memo && <p className="text-[10px] text-gray-500 mt-1">📝 {t.memo}</p>}
                                            </div>
                                            <div className="flex items-center gap-2"><span className={`font-bold ${t.type === 'income' ? theme.incomeText : theme.expenseText}`}>{formatCurrency(t.amount, currency)}</span><button onClick={() => handleEditClick(t)}><Pencil size={16} className="text-gray-400"/></button><button onClick={() => handleDelete(t.id)}><X size={16} className="text-gray-400"/></button></div>
                                        </div>
                                    ))}
                                    {selectedDateDetail.items.length === 0 && <div className={`text-center py-4 ${theme.subText}`}>내역 없음</div>}
                                </div>
                                <div className="p-2 border-t border-gray-100 dark:border-neutral-800"><button onClick={() => { setEditingId(null); setIsModalOpen(true); setNewTrans(prev => ({...prev, date: selectedDateDetail.dateStr, amount: '', desc: ''})); setSelectedDateDetail(null); }} className="w-full py-3 rounded-lg border border-dashed border-blue-500/30 text-blue-500 text-sm flex items-center justify-center gap-2"><Plus size={16} /> 추가하기</button></div>
                            </div>
                        </div>
                    )}

                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh] ${theme.card}`}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>설정</h3><button onClick={() => setIsSettingsOpen(false)} className={theme.subText}><X size={20} /></button></div>
                                <div className={`flex border-b ${theme.border}`}>
                                    <button onClick={() => setSettingsTab('general')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'general' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>기본 설정</button>
                                    <button onClick={() => setSettingsTab('main_category')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'main_category' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>대항목 관리</button>
                                    <button onClick={() => setSettingsTab('sub_category')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'sub_category' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>소항목 관리</button>
                                </div>
                                <div className="p-4 space-y-4 overflow-y-auto">
                                    {settingsTab === 'general' ? (
                                        <>
                                            <div className="pb-4 border-b border-gray-200 dark:border-neutral-800">
                                                <h4 className={`text-sm font-bold mb-2 ${theme.cardText}`}>백업/복원</h4>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={handleExport} className={`flex flex-col items-center p-2 rounded border border-dashed ${theme.border} ${theme.subText}`}><Download size={16} /><span className="text-xs mt-1">저장</span></button>
                                                    <label className={`flex flex-col items-center p-2 rounded border border-dashed ${theme.border} ${theme.subText}`}><Upload size={16} /><span className="text-xs mt-1">복원</span><input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                                </div>
                                            </div>
                                            <div><label className={`text-xs block mb-1 ${theme.subText}`}>기초 잔액</label><input type="number" value={initialBalance} onChange={(e) => setInitialBalance(Number(e.target.value))} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                            <div><label className={`text-xs block mb-1 ${theme.subText}`}>통화</label><div className="flex gap-2"><button onClick={() => setCurrency('KRW')} className={`flex-1 py-2 text-sm border rounded ${currency === 'KRW' ? 'bg-blue-600 text-white' : theme.input}`}>원 (₩)</button><button onClick={() => setCurrency('CNY')} className={`flex-1 py-2 text-sm border rounded ${currency === 'CNY' ? 'bg-blue-600 text-white' : theme.input}`}>위안 (¥)</button></div></div>
                                        </>
                                    ) : (
                                        renderCategoryManager(settingsTab === 'main_category')
                                    )}
                                </div>
                                <div className={`p-4 border-t ${theme.border}`}><button onClick={() => setIsSettingsOpen(false)} className="w-full bg-blue-600 text-white py-2 rounded">닫기</button></div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden ${theme.card}`}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>{editingId ? '수정' : '추가'}</h3><button onClick={() => setIsModalOpen(false)} className={theme.subText}><X size={20} /></button></div>
                                <form onSubmit={handleSaveTransaction} className="p-4 space-y-3">
                                    <div className="flex gap-2">
                                        <div className="flex-1"><label className={`text-xs block mb-1 ${theme.subText}`}>날짜</label><input type="date" required value={newTrans.date} onChange={(e) => setNewTrans({ ...newTrans, date: e.target.value })} className={`w-full rounded border px-2 py-2 text-sm ${theme.input}`} /></div>
                                        <div className="flex-1"><label className={`text-xs block mb-1 ${theme.subText}`}>유형</label><div className="flex gap-1"><button type="button" onClick={() => setNewTrans({ ...newTrans, type: 'income' })} className={`flex-1 py-2 text-sm rounded ${newTrans.type === 'income' ? 'bg-blue-600 text-white' : theme.input}`}>수입</button><button type="button" onClick={() => setNewTrans({ ...newTrans, type: 'expense' })} className={`flex-1 py-2 text-sm rounded ${newTrans.type === 'expense' ? 'bg-rose-600 text-white' : theme.input}`}>지출</button></div></div>
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className={`text-xs block mb-1 ${theme.subText}`}>대항목</label>
                                            <select value={newTrans.mainCategory} onChange={(e) => setNewTrans({ ...newTrans, mainCategory: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`}>
                                                {(newTrans.type === 'income' ? mainCategories.income : mainCategories.expense).map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="flex-1">
                                            <label className={`text-xs block mb-1 ${theme.subText}`}>소항목</label>
                                            <select value={newTrans.category} onChange={(e) => setNewTrans({ ...newTrans, category: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`}>
                                                {(newTrans.type === 'income' ? categories.income : categories.expense).map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>금액</label><input type="number" required min="0" placeholder="0" value={newTrans.amount} onChange={(e) => setNewTrans({ ...newTrans, amount: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>내용</label><input type="text" required placeholder="내용 입력" value={newTrans.desc} onChange={(e) => setNewTrans({ ...newTrans, desc: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>메모</label><input type="text" placeholder="메모 (목록에만 표시됨)" value={newTrans.memo} onChange={(e) => setNewTrans({ ...newTrans, memo: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded mt-2">{editingId ? '수정 완료' : '저장'}</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
