<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BK v1.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-black text-gray-100 font-sans selection:bg-blue-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { ChevronLeft, ChevronRight, Plus, X, Wallet, TrendingUp, TrendingDown, Calendar as CalendarIcon, Settings, Moon, Sun, List, LayoutGrid, Download, Upload, Pencil, PieChart, BarChart3, Trash2, Scale, Layers, LineChart } from 'lucide-react';

        // --- 버전 관리 상수 ---
        const APP_VERSION = "v1.6";

        const formatCurrency = (amount, currency) => {
            const options = { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 };
            return new Intl.NumberFormat(currency === 'KRW' ? 'ko-KR' : 'zh-CN', options).format(amount);
        };

        // 숫자를 짧게 줄여주는 헬퍼 (예: 110000 -> 11만, 57000 -> 5.7만)
        const formatCompactNumber = (number) => {
            if (number === 0) return '';
            // 1만 미만은 그대로, 이상은 '만' 단위 축약
            if (Math.abs(number) < 10000) return new Intl.NumberFormat('ko-KR').format(number);
            const val = number / 10000;
            return val.toFixed(val % 1 === 0 ? 0 : 1) + '만';
        };

        const generateCalendarDays = (year, month) => {
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = lastDayOfMonth.getDate();
            const days = [];
            for (let i = 0; i < startDayOfWeek; i++) days.push({ day: null, dateStr: null });
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                days.push({ day: i, dateStr: dateStr });
            }
            return days;
        };

        const DEFAULT_CATEGORIES = {
            income: ['급여', '용돈', '상여금', '금융수입', '기타'],
            expense: ['식비', '교통', '문화', '공과금', '쇼핑', '주거', '의료', '기타']
        };

        function App() {
            const [isLoaded, setIsLoaded] = useState(false);
            const [initialBalance, setInitialBalance] = useState(0);
            const [currency, setCurrency] = useState('KRW'); 
            const [isDarkMode, setIsDarkMode] = useState(true); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('calendar');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [transactions, setTransactions] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedDateDetail, setSelectedDateDetail] = useState(null); 
            const [settingsTab, setSettingsTab] = useState('general');
            const [newCategoryName, setNewCategoryName] = useState('');
            const [categoryTypeToAdd, setCategoryTypeToAdd] = useState('expense');
            
            const [newTrans, setNewTrans] = useState({
                date: new Date().toISOString().split('T')[0],
                type: 'expense',
                category: '',
                amount: '',
                desc: ''
            });

            useEffect(() => {
                const savedData = localStorage.getItem('bk_budget_data_v5');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                        if (parsed.currency) setCurrency(parsed.currency);
                        if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                        if (parsed.transactions) setTransactions(parsed.transactions);
                        if (parsed.categories) setCategories(parsed.categories);
                    } catch (e) { console.error(e); }
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories };
                    localStorage.setItem('bk_budget_data_v5', JSON.stringify(dataToSave)); 
                }
            }, [initialBalance, currency, isDarkMode, transactions, categories, isLoaded]);

            useEffect(() => {
                if (isModalOpen && !editingId) {
                    const currentCats = newTrans.type === 'income' ? categories.income : categories.expense;
                    if (currentCats.length > 0) {
                        setNewTrans(prev => ({ ...prev, category: currentCats[0] }));
                    }
                }
            }, [newTrans.type, categories, isModalOpen, editingId]);

            const handleExport = () => {
                const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories, exportDate: new Date().toISOString(), version: APP_VERSION };
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `BK_Budget_${APP_VERSION}_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if (window.confirm("복원하시겠습니까? 기존 데이터는 삭제됩니다.")) {
                            if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                            if (parsed.currency) setCurrency(parsed.currency);
                            if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                            if (parsed.transactions) setTransactions(parsed.transactions);
                            if (parsed.categories) setCategories(parsed.categories);
                            alert("복원 완료");
                            setIsSettingsOpen(false);
                        }
                    } catch (err) { alert("파일 오류"); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); 
            const sortedTransactions = useMemo(() => [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date)), [transactions]);

            const dailyStatsMap = useMemo(() => {
                const stats = {};
                let runningBalance = Number(initialBalance); 
                sortedTransactions.forEach(t => {
                    const dateKey = t.date;
                    if (!stats[dateKey]) stats[dateKey] = { income: 0, expense: 0, balance: 0 };
                    if (t.type === 'income') { stats[dateKey].income += Number(t.amount); runningBalance += Number(t.amount); }
                    else { stats[dateKey].expense += Number(t.amount); runningBalance -= Number(t.amount); }
                    stats[dateKey].balance = runningBalance;
                });
                return { stats, finalBalance: runningBalance };
            }, [sortedTransactions, initialBalance]);

            const allTimeStats = useMemo(() => {
                let income = 0;
                let expense = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') income += Number(t.amount);
                    else expense += Number(t.amount);
                });
                const balance = Number(initialBalance) + income - expense;
                return { income, expense, balance };
            }, [transactions, initialBalance]);

            const yearlyStats = useMemo(() => {
                const monthlyData = Array(12).fill(null).map((_, i) => ({ month: i + 1, income: 0, expense: 0, balance: 0 }));
                const categoryData = { income: {}, expense: {} };
                
                categories.income.forEach(cat => categoryData.income[cat] = Array(12).fill(0));
                categories.expense.forEach(cat => categoryData.expense[cat] = Array(12).fill(0));

                const yearTransactions = transactions.filter(t => t.date.startsWith(String(year)));
                
                yearTransactions.forEach(t => {
                    const m = new Date(t.date).getMonth(); 
                    const cat = t.category || '기타';
                    const amt = Number(t.amount);

                    if (t.type === 'income') {
                        monthlyData[m].income += amt;
                        if (!categoryData.income[cat]) categoryData.income[cat] = Array(12).fill(0);
                        categoryData.income[cat][m] += amt;
                    } else {
                        monthlyData[m].expense += amt;
                        if (!categoryData.expense[cat]) categoryData.expense[cat] = Array(12).fill(0);
                        categoryData.expense[cat][m] += amt;
                    }
                });

                let maxVal = 0;
                monthlyData.forEach(s => {
                    s.balance = s.income - s.expense;
                    if (s.income > maxVal) maxVal = s.income;
                    if (s.expense > maxVal) maxVal = s.expense;
                    // 잔액이 매우 클 수 있으므로 잔액도 최대값 계산에 포함 (선 그래프 스케일링)
                    if (Math.abs(s.balance) > maxVal) maxVal = Math.abs(s.balance);
                });

                // 그래프 여백을 위해 maxVal 약간 증가
                maxVal = maxVal * 1.1 || 1;

                return { monthlyData, categoryData, maxVal }; 
            }, [transactions, year, categories]);

            // SVG용 Path 생성 (부드러운 곡선)
            const getSmoothPath = (data, maxVal, width, height) => {
                if (data.length === 0) return "";
                
                const points = data.map((d, i) => {
                    const x = (i / 11) * width; // 12개월 분할
                    // Y축: 값 0이 height(바닥)이 아니라 중간일 수도 있음? 아니 보통 0이 바닥. 
                    // 하지만 잔액은 음수일 수도 있음. 여기서는 막대그래프와 동일하게 0을 바닥으로 둠. 음수는 무시하거나 0으로 처리?
                    // 요청상 "월간 잔액"이므로 양수일 확률 높음. 0 이하는 바닥에 붙임.
                    const val = Math.max(0, d.balance);
                    const y = height - (val / maxVal) * height;
                    return [x, y];
                });

                if (points.length === 1) return `M ${points[0][0]},${points[0][1]}`;

                // Catmull-Rom to Cubic Bezier conversion logic simplified
                const line = (pointA, pointB) => {
                    const lengthX = pointB[0] - pointA[0];
                    const lengthY = pointB[1] - pointA[1];
                    return {
                        length: Math.sqrt(Math.pow(lengthX, 2) + Math.pow(lengthY, 2)),
                        angle: Math.atan2(lengthY, lengthX)
                    };
                };

                const controlPoint = (current, previous, next, reverse) => {
                    const p = previous || current;
                    const n = next || current;
                    const o = line(p, n);
                    const angle = o.angle + (reverse ? Math.PI : 0);
                    const length = o.length * 0.2;
                    const x = current[0] + Math.cos(angle) * length;
                    const y = current[1] + Math.sin(angle) * length;
                    return [x, y];
                };

                const bezierCommand = (point, i, a) => {
                    const cps = controlPoint(a[i - 1], a[i - 2], point);
                    const cpe = controlPoint(point, a[i - 1], a[i + 1], true);
                    return `C ${cps[0]},${cps[1]} ${cpe[0]},${cpe[1]} ${point[0]},${point[1]}`;
                };

                const d = points.reduce((acc, point, i, a) => i === 0
                    ? `M ${point[0]},${point[1]}`
                    : `${acc} ${bezierCommand(point, i, a)}`
                , "");
                
                return d;
            };

            const categoryStats = useMemo(() => {
                const startStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endStr = `${year}-${String(month + 1).padStart(2, '0')}-31`;
                const prevDate = new Date(year, month - 1, 1);
                const prevYear = prevDate.getFullYear();
                const prevMonth = prevDate.getMonth();
                const prevStartStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-01`;
                const prevEndStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-31`;

                let carryover = Number(initialBalance);
                transactions.forEach(t => {
                    if (t.date < startStr) {
                        if (t.type === 'income') carryover += Number(t.amount);
                        else carryover -= Number(t.amount);
                    }
                });

                const currentMonthTrans = transactions.filter(t => t.date >= startStr && t.date <= endStr);
                const prevMonthTrans = transactions.filter(t => t.date >= prevStartStr && t.date <= prevEndStr);

                const incomeMap = {};
                const expenseMap = {};
                const prevIncomeMap = {};
                const prevExpenseMap = {};

                currentMonthTrans.forEach(t => {
                    const targetMap = t.type === 'income' ? incomeMap : expenseMap;
                    const cat = t.category || '미분류';
                    targetMap[cat] = (targetMap[cat] || 0) + Number(t.amount);
                });

                prevMonthTrans.forEach(t => {
                    const targetMap = t.type === 'income' ? prevIncomeMap : prevExpenseMap;
                    const cat = t.category || '미분류';
                    targetMap[cat] = (targetMap[cat] || 0) + Number(t.amount);
                });

                const sortStats = (map) => Object.entries(map).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                const monthlyIncome = Object.values(incomeMap).reduce((a, b) => a + b, 0);
                const monthlyExpense = Object.values(expenseMap).reduce((a, b) => a + b, 0);
                const totalRevenue = carryover + monthlyIncome;
                const finalBalance = totalRevenue - monthlyExpense;

                return {
                    income: sortStats(incomeMap),
                    expense: sortStats(expenseMap),
                    prevIncomeMap,
                    prevExpenseMap,
                    monthlyIncome,
                    monthlyExpense,
                    carryover,
                    totalRevenue, 
                    finalBalance 
                };
            }, [transactions, year, month, initialBalance]);

            const getBalanceAtDate = (targetDateStr) => {
                let balance = Number(initialBalance); 
                for (const t of sortedTransactions) {
                    if (t.date > targetDateStr) break;
                    if (t.type === 'income') balance += Number(t.amount);
                    else balance -= Number(t.amount);
                }
                return balance;
            };

            const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const handleNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
            
            const handleSaveTransaction = (e) => {
                e.preventDefault();
                if (!newTrans.amount || !newTrans.desc) return;
                const currentCats = newTrans.type === 'income' ? categories.income : categories.expense;
                const categoryToSave = newTrans.category || currentCats[0] || '기타';
                const transToSave = { ...newTrans, category: categoryToSave, amount: Number(newTrans.amount) };
                if (editingId) {
                    setTransactions(prev => prev.map(t => t.id === editingId ? { ...transToSave, id: editingId } : t));
                } else {
                    setTransactions([...transactions, { id: Date.now(), ...transToSave }]);
                }
                setIsModalOpen(false); setEditingId(null); setNewTrans({ ...newTrans, amount: '', desc: '', category: '' }); setSelectedDateDetail(null);
            };

            const handleEditClick = (transaction) => {
                setEditingId(transaction.id);
                setNewTrans({ date: transaction.date, type: transaction.type, amount: transaction.amount, desc: transaction.desc, category: transaction.category || '' });
                setIsModalOpen(true);
                setSelectedDateDetail(null);
            };

            const handleDelete = (id) => {
                if (window.confirm("삭제하시겠습니까?")) {
                    setTransactions(transactions.filter(t => t.id !== id));
                    if (selectedDateDetail) setSelectedDateDetail(prev => ({ ...prev, items: prev.items.filter(i => i.id !== id) }));
                }
            };

            const handleDateClick = (dateStr) => {
                if (!dateStr) return;
                const dayTrans = transactions.filter(t => t.date === dateStr);
                setSelectedDateDetail({ dateStr, items: dayTrans });
            };

            const handleAddCategory = () => {
                if (!newCategoryName.trim()) return;
                const type = categoryTypeToAdd;
                if (categories[type].includes(newCategoryName)) { alert('이미 존재함'); return; }
                setCategories(prev => ({ ...prev, [type]: [...prev[type], newCategoryName] }));
                setNewCategoryName('');
            };

            const handleDeleteCategory = (type, name) => {
                if (categories[type].length <= 1) { alert('최소 1개 필수'); return; }
                if (window.confirm('삭제하시겠습니까?')) {
                    setCategories(prev => ({ ...prev, [type]: prev[type].filter(c => c !== name) }));
                }
            };

            const calendarDays = generateCalendarDays(year, month);
            
            const theme = {
                bg: isDarkMode ? 'bg-black' : 'bg-gray-50',
                text: isDarkMode ? 'text-gray-100' : 'text-gray-800',
                card: isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-200',
                cardText: isDarkMode ? 'text-gray-200' : 'text-gray-900',
                subText: isDarkMode ? 'text-gray-400' : 'text-gray-500',
                border: isDarkMode ? 'border-neutral-800' : 'border-gray-200',
                hover: isDarkMode ? 'hover:bg-neutral-800' : 'hover:bg-gray-50',
                input: isDarkMode ? 'bg-neutral-800 border-neutral-700 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-900',
                header: isDarkMode ? 'bg-black border-neutral-800' : 'bg-white border-gray-200',
                th: isDarkMode ? 'bg-neutral-900 text-gray-400' : 'bg-gray-50 text-gray-600',
                gridLine: isDarkMode ? 'border-neutral-800' : 'border-gray-100',
                today: isDarkMode ? 'bg-indigo-900/40' : 'bg-indigo-50/30',
                incomeText: isDarkMode ? 'text-blue-400' : 'text-blue-600',
                incomeBg: isDarkMode ? 'bg-blue-500/20' : 'bg-blue-100',
                expenseText: isDarkMode ? 'text-rose-400' : 'text-rose-600',
                expenseBg: isDarkMode ? 'bg-rose-500/20' : 'bg-red-100',
            };

            if (!isLoaded) return null; 

            // 전월 대비 증감 렌더링
            const renderComparison = (currentVal, category, type) => {
                const prevMap = type === 'income' ? categoryStats.prevIncomeMap : categoryStats.prevExpenseMap;
                const prevVal = prevMap[category] || 0;
                const diff = currentVal - prevVal;
                let diffText = <span className="text-gray-500">-</span>;
                if (diff > 0) {
                    const colorClass = type === 'income' ? 'text-blue-500' : 'text-rose-500';
                    diffText = <span className={colorClass}>▲{formatCurrency(diff, currency).replace(/[₩¥CNY]/g, '').trim()}</span>;
                } else if (diff < 0) {
                    const colorClass = type === 'income' ? 'text-rose-500' : 'text-blue-500';
                    diffText = <span className={colorClass}>▼{formatCurrency(Math.abs(diff), currency).replace(/[₩¥CNY]/g, '').trim()}</span>;
                }
                return (
                    <div className="flex items-center gap-2 text-[10px] sm:text-xs">
                        <span className="text-gray-400">전월 {formatCurrency(prevVal, currency).replace(/[₩¥CNY]/g, '').trim()}</span>
                        {diffText}
                    </div>
                );
            };

            return (
                <div className={`min-h-screen font-sans transition-colors duration-200 ${theme.bg} ${theme.text}`}>
                    <header className={`sticky top-0 z-10 border-b ${theme.header}`}>
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-2 rounded-lg text-white"><CalendarIcon size={20} /></div>
                                <div className="flex items-end gap-1">
                                    <h1 className={`text-xl font-bold tracking-tight ${theme.cardText}`}>BK</h1>
                                    <span className={`text-xs font-mono mb-1 ${theme.subText}`}>{APP_VERSION}</span>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full ${theme.hover} ${theme.subText}`}><Sun size={20} /></button>
                                <button onClick={() => { setIsSettingsOpen(true); setSettingsTab('general'); }} className={`p-2 rounded-full ${theme.hover} ${theme.subText}`}><Settings size={20} /></button>
                                <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className="ml-2 bg-blue-600 text-white px-3 py-2 rounded-md"><Plus size={16} /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-6 pb-20">
                        {/* 1. 상단 대시보드 */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className={`md:col-span-2 rounded-xl border p-4 ${theme.card}`}>
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center gap-2">
                                        <button onClick={handlePrevMonth} className={`p-1 rounded ${theme.hover}`}><ChevronLeft size={18} /></button>
                                        <h2 className={`text-lg font-bold ${theme.cardText}`}>{year}년 {month + 1}월</h2>
                                        <button onClick={handleNextMonth} className={`p-1 rounded ${theme.hover}`}><ChevronRight size={18} /></button>
                                    </div>
                                    <span className="text-xs font-medium px-2 py-1 rounded bg-neutral-800 text-gray-400">월간 현황</span>
                                </div>
                                <div className="grid grid-cols-2 sm:grid-cols-5 gap-y-4 gap-x-2 text-center sm:divide-x sm:divide-neutral-800">
                                    <div><p className={`text-xs ${theme.subText} mb-1`}>전월 이월</p><p className={`font-bold text-sm sm:text-base ${theme.cardText}`}>{formatCurrency(categoryStats.carryover, currency)}</p></div>
                                    <div><p className={`text-xs ${theme.subText} mb-1`}>수입</p><p className={`font-bold text-sm sm:text-base ${theme.incomeText}`}>{formatCurrency(categoryStats.monthlyIncome, currency)}</p></div>
                                    <div className="hidden sm:block"><p className={`text-xs ${theme.subText} mb-1`}>총수입</p><p className={`font-bold text-sm sm:text-base ${theme.cardText}`}>{formatCurrency(categoryStats.totalRevenue, currency)}</p></div>
                                    <div><p className={`text-xs ${theme.subText} mb-1`}>지출</p><p className={`font-bold text-sm sm:text-base ${theme.expenseText}`}>{formatCurrency(categoryStats.monthlyExpense, currency)}</p></div>
                                    <div className="col-span-2 sm:col-span-1 border-t sm:border-t-0 pt-2 sm:pt-0 border-neutral-800"><p className={`text-xs ${theme.subText} mb-1`}>잔액</p><p className={`font-bold text-sm sm:text-base ${categoryStats.finalBalance >= 0 ? theme.incomeText : theme.expenseText}`}>{formatCurrency(categoryStats.finalBalance, currency)}</p></div>
                                </div>
                                <div className="sm:hidden mt-2 pt-2 border-t border-neutral-800 flex justify-between text-xs px-2"><span className={theme.subText}>총수입 (이월+수입)</span><span className={theme.cardText}>{formatCurrency(categoryStats.totalRevenue, currency)}</span></div>
                            </div>
                            <div className={`md:col-span-1 rounded-xl border p-4 flex flex-col justify-center relative overflow-hidden ${isDarkMode ? 'bg-blue-900/10 border-blue-800/30' : 'bg-blue-50 border-blue-200'}`}>
                                <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                <div className="flex items-center gap-2 mb-3 pb-2 border-b border-blue-500/20"><Layers size={16} className="text-blue-500"/><span className={`text-xs font-bold uppercase tracking-wider ${theme.subText}`}>전체 누적 현황</span></div>
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center text-sm"><span className={theme.subText}>누적 수입</span><span className="text-blue-500 font-medium">+{formatCurrency(allTimeStats.income, currency)}</span></div>
                                    <div className="flex justify-between items-center text-sm"><span className={theme.subText}>누적 지출</span><span className="text-rose-500 font-medium">-{formatCurrency(allTimeStats.expense, currency)}</span></div>
                                    <div className="flex justify-between items-center text-sm pt-2 border-t border-blue-500/20"><span className={`${theme.cardText} font-bold`}>누적 잔액</span><span className={`text-lg font-bold ${isDarkMode ? 'text-blue-100' : 'text-blue-700'}`}>{formatCurrency(allTimeStats.balance, currency)}</span></div>
                                </div>
                            </div>
                        </div>

                        {/* 탭 메뉴 */}
                        <div className="flex gap-2 mb-4 border-b border-gray-200 dark:border-neutral-800">
                            <button onClick={() => setActiveTab('calendar')} className={`pb-3 px-4 text-sm font-medium flex items-center gap-2 border-b-2 ${activeTab === 'calendar' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><LayoutGrid size={18} />달력</button>
                            <button onClick={() => setActiveTab('list')} className={`pb-3 px-4 text-sm font-medium flex items-center gap-2 border-b-2 ${activeTab === 'list' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><List size={18} />목록</button>
                            <button onClick={() => setActiveTab('stats')} className={`pb-3 px-4 text-sm font-medium flex items-center gap-2 border-b-2 ${activeTab === 'stats' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><BarChart3 size={18} />통계</button>
                            <button onClick={() => setActiveTab('yearly')} className={`pb-3 px-4 text-sm font-medium flex items-center gap-2 border-b-2 ${activeTab === 'yearly' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><LineChart size={18} />연간</button>
                        </div>

                        {activeTab === 'calendar' && (
                            <div className={`rounded-xl shadow border overflow-hidden ${theme.card}`}>
                                <div className={`grid grid-cols-7 border-b ${theme.border} ${theme.th}`}>
                                    {['일', '월', '화', '수', '목', '금', '토'].map((day, idx) => (<div key={day} className={`py-3 text-center text-xs font-semibold ${idx === 0 ? 'text-red-500' : idx === 6 ? 'text-blue-500' : ''}`}>{day}</div>))}
                                </div>
                                <div className="grid grid-cols-7 auto-rows-fr">
                                    {calendarDays.map((item, idx) => {
                                        if (!item.day) return <div key={`empty-${idx}`} className={`min-h-[100px] sm:min-h-[140px] border-b border-r last:border-r-0 ${theme.gridLine}`}></div>;
                                        const dateStats = dailyStatsMap.stats[item.dateStr];
                                        const currentBalance = dateStats ? dateStats.balance : getBalanceAtDate(item.dateStr);
                                        const isToday = item.dateStr === new Date().toISOString().split('T')[0];
                                        const dayTransactions = transactions.filter(t => t.date === item.dateStr);

                                        return (
                                            <div key={item.dateStr} onClick={() => handleDateClick(item.dateStr)} className={`min-h-[100px] sm:min-h-[140px] p-1 border-b border-r last:border-r-0 relative cursor-pointer ${theme.gridLine} ${theme.hover} ${isToday ? theme.today : ''}`}>
                                                <div className="flex flex-col sm:flex-row justify-between items-start mb-1">
                                                    <span className={`text-[10px] sm:text-sm font-medium w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : theme.subText}`}>{item.day}</span>
                                                    <span className={`text-[8px] sm:text-[10px] px-1 rounded ${isDarkMode ? 'bg-neutral-800 text-gray-400' : 'bg-gray-100 text-gray-500'}`}>{formatCurrency(currentBalance, currency)}</span>
                                                </div>
                                                <div className="flex flex-col gap-0.5 overflow-hidden h-[70px] sm:h-[90px] overflow-y-auto scrollbar-hide">
                                                    {dayTransactions.map((t) => (
                                                        <div key={t.id} className={`text-[9px] sm:text-[11px] flex justify-between items-center px-1 py-0.5 rounded ${t.type === 'income' ? `${theme.incomeBg} ${theme.incomeText}` : `${theme.expenseBg} ${theme.expenseText}`}`}>
                                                            <div className="flex items-center gap-1 truncate max-w-[65%]">
                                                                <span className="opacity-75 text-[8px] border px-0.5 rounded border-current">{t.category}</span>
                                                                <span className="truncate">{t.desc}</span>
                                                            </div>
                                                            <span className="text-[9px]">{formatCurrency(t.amount, currency).replace(/[₩¥CNY]/g, '').trim()}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'list' && (
                            <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                <div className="space-y-3">
                                    {transactions.filter(t => t.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)).sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => (
                                        <div key={t.id} className={`flex justify-between items-center p-3 rounded border ${theme.border} ${theme.bg}`}>
                                            <div>
                                                <p className={`text-xs ${theme.subText} mb-0.5`}>{t.date}</p>
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded border ${t.type === 'income' ? 'border-blue-500 text-blue-500' : 'border-rose-500 text-rose-500'}`}>{t.category}</span>
                                                    <p className={`font-medium ${theme.cardText}`}>{t.desc}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className={`font-bold ${t.type === 'income' ? theme.incomeText : theme.expenseText}`}>{t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount, currency)}</span>
                                                <div className="flex gap-2"><button onClick={() => handleEditClick(t)} className="text-gray-400"><Pencil size={16}/></button><button onClick={() => handleDelete(t.id)} className="text-gray-400"><X size={16}/></button></div>
                                            </div>
                                        </div>
                                    ))}
                                    {transactions.filter(t => t.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)).length === 0 && <div className={`text-center py-10 ${theme.subText}`}>내역 없음</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6 animate-in fade-in zoom-in duration-200">
                                <div className={`rounded-xl shadow border p-5 ${theme.card}`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className={`font-bold flex items-center gap-2 ${theme.cardText}`}>
                                            <Scale size={18} className="text-gray-400"/>
                                            이번 달 수지
                                        </h3>
                                        <span className={`text-lg font-bold ${categoryStats.finalBalance >= 0 ? theme.incomeText : theme.expenseText}`}>
                                            {formatCurrency(categoryStats.finalBalance, currency)}
                                        </span>
                                    </div>
                                    <div className="relative h-4 bg-neutral-800 rounded-full overflow-hidden mb-2">
                                        <div 
                                            className="absolute left-0 top-0 h-full bg-blue-500" 
                                            style={{ width: `${categoryStats.totalRevenue > 0 ? (categoryStats.totalRevenue / (categoryStats.totalRevenue + categoryStats.monthlyExpense)) * 100 : 0}%` }}
                                        ></div>
                                        <div 
                                            className="absolute right-0 top-0 h-full bg-rose-500" 
                                            style={{ width: `${categoryStats.monthlyExpense > 0 ? (categoryStats.monthlyExpense / (categoryStats.totalRevenue + categoryStats.monthlyExpense)) * 100 : 0}%` }}
                                        ></div>
                                    </div>
                                    <div className="flex justify-between text-xs">
                                        <span className="text-blue-500">가용(총수입) {formatCurrency(categoryStats.totalRevenue, currency)}</span>
                                        <span className="text-rose-500">지출 {formatCurrency(categoryStats.monthlyExpense, currency)}</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                        <h3 className={`font-bold mb-4 flex items-center gap-2 ${theme.cardText}`}><TrendingDown size={18} className="text-rose-500"/>지출 분석</h3>
                                        <div className="space-y-3">
                                            {categoryStats.expense.map((item, idx) => (
                                                <div key={item.name}>
                                                    <div className="flex justify-between items-end text-xs mb-1">
                                                        <span className={theme.cardText}>{item.name}</span>
                                                        <div className="flex gap-2 items-end">
                                                            {renderComparison(item.value, item.name, 'expense')}
                                                            <span className={`${theme.expenseText} font-bold text-sm`}>
                                                                {formatCurrency(item.value, currency)}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div className="w-full bg-neutral-800 rounded-full h-2.5 overflow-hidden">
                                                        <div className="bg-rose-500 h-2.5 rounded-full" style={{ width: `${categoryStats.monthlyExpense > 0 ? (item.value / categoryStats.monthlyExpense) * 100 : 0}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                            {categoryStats.expense.length === 0 && <p className={`text-center text-sm py-4 ${theme.subText}`}>지출 내역이 없습니다.</p>}
                                        </div>
                                    </div>

                                    <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                        <h3 className={`font-bold mb-4 flex items-center gap-2 ${theme.cardText}`}><TrendingUp size={18} className="text-blue-500"/>수입 분석</h3>
                                        <div className="space-y-3">
                                            {categoryStats.income.map((item, idx) => (
                                                <div key={item.name}>
                                                    <div className="flex justify-between items-end text-xs mb-1">
                                                        <span className={theme.cardText}>{item.name}</span>
                                                        <div className="flex gap-2 items-end">
                                                            {renderComparison(item.value, item.name, 'income')}
                                                            <span className={`${theme.incomeText} font-bold text-sm`}>
                                                                {formatCurrency(item.value, currency)}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div className="w-full bg-neutral-800 rounded-full h-2.5 overflow-hidden">
                                                        <div className="bg-blue-500 h-2.5 rounded-full" style={{ width: `${categoryStats.monthlyIncome > 0 ? (item.value / categoryStats.monthlyIncome) * 100 : 0}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                            {categoryStats.income.length === 0 && <p className={`text-center text-sm py-4 ${theme.subText}`}>수입 내역이 없습니다.</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'yearly' && (
                            <div className={`rounded-xl shadow border p-5 animate-in fade-in zoom-in duration-200 ${theme.card}`}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className={`font-bold flex items-center gap-2 ${theme.cardText}`}>
                                        <BarChart3 size={18} className="text-gray-400"/>
                                        {year}년 연간 흐름
                                    </h3>
                                    <span className={`text-xs ${theme.subText}`}>1월 - 12월</span>
                                </div>
                                
                                {/* SVG 차트 (막대 + 곡선) */}
                                <div className="overflow-x-auto pb-4 mb-6">
                                    <div className="min-w-[500px] h-64 relative">
                                        <svg width="100%" height="100%" viewBox="0 0 500 250" preserveAspectRatio="none">
                                            {/* 꺾은선 (잔액) - 맨 뒤로 보내거나 맨 위로? 보통 위가 좋음. 순서대로 그리면 됨 */}
                                            {/* 막대 그래프 */}
                                            {yearlyStats.monthlyData.map((stat, i) => {
                                                const barWidth = 12; 
                                                const gap = 4;
                                                // 500 width / 12 months = ~41.6px per month section
                                                const xBase = (i / 11) * 460 + 10; // 약간 여유
                                                
                                                const hIncome = (stat.income / yearlyStats.maxVal) * 200;
                                                const hExpense = (stat.expense / yearlyStats.maxVal) * 200;
                                                
                                                return (
                                                    <g key={i}>
                                                        {/* 수입 막대 (파랑) */}
                                                        {stat.income > 0 && (
                                                            <rect x={xBase - barWidth - gap/2} y={230 - hIncome} width={barWidth} height={hIncome} rx="2" fill="#3b82f6" />
                                                        )}
                                                        {/* 지출 막대 (빨강) */}
                                                        {stat.expense > 0 && (
                                                            <rect x={xBase + gap/2} y={230 - hExpense} width={barWidth} height={hExpense} rx="2" fill="#e11d48" />
                                                        )}
                                                    </g>
                                                )
                                            })}

                                            {/* 꺾은선 그래프 (잔액) - 부드러운 곡선 */}
                                            <path 
                                                d={getSmoothPath(yearlyStats.monthlyData, yearlyStats.maxVal, 460, 230)} 
                                                fill="none" 
                                                stroke="#2dd4bf" 
                                                strokeWidth="3" 
                                                strokeLinecap="round" 
                                                transform="translate(10, 0)" // x좌표 보정
                                                style={{ filter: 'drop-shadow(0px 2px 4px rgba(0,0,0,0.5))' }}
                                            />

                                            {/* 꺾은선 포인트 및 텍스트 */}
                                            {yearlyStats.monthlyData.map((stat, i) => {
                                                const xBase = (i / 11) * 460 + 10;
                                                const val = Math.max(0, stat.balance);
                                                const y = 230 - (val / yearlyStats.maxVal) * 230;
                                                
                                                return (
                                                    <circle key={i} cx={xBase} cy={y} r="3" fill="#2dd4bf" stroke="#fff" strokeWidth="1" />
                                                );
                                            })}
                                        </svg>

                                        {/* HTML 오버레이 텍스트 (SVG 안에 넣으면 스타일링 귀찮으므로 위에 덮음) */}
                                        <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
                                            {yearlyStats.monthlyData.map((stat, i) => {
                                                const xPercent = (i / 11) * 92 + 2; // 대략적 위치
                                                const hIncome = (stat.income / yearlyStats.maxVal) * 100;
                                                const hExpense = (stat.expense / yearlyStats.maxVal) * 100;
                                                
                                                return (
                                                    <div key={i} className="absolute h-full flex items-end justify-center" style={{ left: `${xPercent}%`, width: '40px', transform: 'translateX(-50%)', bottom: '20px' }}>
                                                        {/* 수입 텍스트 */}
                                                        {stat.income > 0 && (
                                                            <span 
                                                                className="absolute text-[9px] text-white font-bold drop-shadow-md whitespace-nowrap"
                                                                style={{ bottom: `${hIncome/2.5 + 2}%`, left: '-4px' }} // 막대 중간쯤
                                                            >
                                                                {formatCompactNumber(stat.income)}
                                                            </span>
                                                        )}
                                                        {/* 지출 텍스트 */}
                                                        {stat.expense > 0 && (
                                                            <span 
                                                                className="absolute text-[9px] text-white font-bold drop-shadow-md whitespace-nowrap"
                                                                style={{ bottom: `${hExpense/2.5 + 2}%`, left: '16px' }}
                                                            >
                                                                {formatCompactNumber(stat.expense)}
                                                            </span>
                                                        )}
                                                        {/* 월 라벨 */}
                                                        <span className="absolute -bottom-6 text-[10px] text-gray-500">{stat.month}월</span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-8">
                                    <h4 className={`text-sm font-bold mb-4 ${theme.cardText}`}>항목별 상세 흐름</h4>
                                    <div className="overflow-x-auto border border-neutral-800 rounded-lg">
                                        <table className="w-full text-xs text-left min-w-[800px]">
                                            <thead className={`bg-neutral-900 ${theme.subText}`}>
                                                <tr>
                                                    <th className="px-3 py-2 sticky left-0 bg-neutral-900 z-10 border-r border-neutral-800">항목</th>
                                                    {[...Array(12)].map((_, i) => <th key={i} className="px-2 py-2 text-center border-r border-neutral-800 last:border-0 w-[60px]">{i+1}월</th>)}
                                                    <th className="px-3 py-2 text-right bg-neutral-900 sticky right-0 border-l border-neutral-800">합계</th>
                                                </tr>
                                            </thead>
                                            <tbody className={`divide-y divide-neutral-800 ${theme.cardText}`}>
                                                {/* 수입 섹션 */}
                                                <tr className="bg-blue-900/10 font-bold"><td colSpan="14" className="px-3 py-1.5 text-blue-400">수입</td></tr>
                                                {Object.entries(yearlyStats.categoryData.income).map(([cat, months]) => {
                                                    const total = months.reduce((a, b) => a + b, 0);
                                                    if (total === 0) return null;
                                                    return (
                                                        <tr key={cat} className="hover:bg-neutral-800/50">
                                                            <td className="px-3 py-2 font-medium sticky left-0 bg-black z-10 border-r border-neutral-800">{cat}</td>
                                                            {months.map((amt, i) => (
                                                                <td key={i} className={`px-2 py-2 text-center border-r border-neutral-800 last:border-0 ${amt > 0 ? 'text-blue-400' : 'text-neutral-600'}`}>
                                                                    {amt > 0 ? formatCompactNumber(amt) : '-'}
                                                                </td>
                                                            ))}
                                                            <td className="px-3 py-2 text-right font-bold text-blue-500 sticky right-0 bg-black border-l border-neutral-800">{formatCompactNumber(total)}</td>
                                                        </tr>
                                                    );
                                                })}

                                                {/* 지출 섹션 */}
                                                <tr className="bg-rose-900/10 font-bold"><td colSpan="14" className="px-3 py-1.5 text-rose-400">지출</td></tr>
                                                {Object.entries(yearlyStats.categoryData.expense).map(([cat, months]) => {
                                                    const total = months.reduce((a, b) => a + b, 0);
                                                    if (total === 0) return null;
                                                    return (
                                                        <tr key={cat} className="hover:bg-neutral-800/50">
                                                            <td className="px-3 py-2 font-medium sticky left-0 bg-black z-10 border-r border-neutral-800">{cat}</td>
                                                            {months.map((amt, i) => (
                                                                <td key={i} className={`px-2 py-2 text-center border-r border-neutral-800 last:border-0 ${amt > 0 ? 'text-rose-400' : 'text-neutral-600'}`}>
                                                                    {amt > 0 ? formatCompactNumber(amt) : '-'}
                                                                </td>
                                                            ))}
                                                            <td className="px-3 py-2 text-right font-bold text-rose-500 sticky right-0 bg-black border-l border-neutral-800">{formatCompactNumber(total)}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {selectedDateDetail && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={() => setSelectedDateDetail(null)}>
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden ${theme.card}`} onClick={e => e.stopPropagation()}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>{selectedDateDetail.dateStr}</h3><button onClick={() => setSelectedDateDetail(null)} className={theme.subText}><X size={20} /></button></div>
                                <div className="max-h-[50vh] overflow-y-auto p-2 space-y-2">
                                    {selectedDateDetail.items.map(t => (
                                        <div key={t.id} className={`flex justify-between items-center p-3 rounded border ${theme.border} ${theme.bg}`}>
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded border ${t.type === 'income' ? 'border-blue-500 text-blue-500' : 'border-rose-500 text-rose-500'}`}>{t.category}</span>
                                                    <p className={`font-medium ${theme.cardText}`}>{t.desc}</p>
                                                </div>
                                                <p className={`text-xs ${theme.subText}`}>{t.type === 'income' ? '수입' : '지출'}</p>
                                            </div>
                                            <div className="flex items-center gap-2"><span className={`font-bold ${t.type === 'income' ? theme.incomeText : theme.expenseText}`}>{formatCurrency(t.amount, currency)}</span><button onClick={() => handleEditClick(t)}><Pencil size={16} className="text-gray-400"/></button><button onClick={() => handleDelete(t.id)}><X size={16} className="text-gray-400"/></button></div>
                                        </div>
                                    ))}
                                    {selectedDateDetail.items.length === 0 && <div className={`text-center py-4 ${theme.subText}`}>내역 없음</div>}
                                </div>
                                <div className="p-2 border-t border-gray-100 dark:border-neutral-800"><button onClick={() => { setEditingId(null); setIsModalOpen(true); setNewTrans(prev => ({...prev, date: selectedDateDetail.dateStr, amount: '', desc: ''})); setSelectedDateDetail(null); }} className="w-full py-3 rounded-lg border border-dashed border-blue-500/30 text-blue-500 text-sm flex items-center justify-center gap-2"><Plus size={16} /> 추가하기</button></div>
                            </div>
                        </div>
                    )}

                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh] ${theme.card}`}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>설정</h3><button onClick={() => setIsSettingsOpen(false)} className={theme.subText}><X size={20} /></button></div>
                                <div className={`flex border-b ${theme.border}`}>
                                    <button onClick={() => setSettingsTab('general')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'general' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>기본 설정</button>
                                    <button onClick={() => setSettingsTab('category')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'category' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>항목 관리</button>
                                </div>
                                <div className="p-4 space-y-4 overflow-y-auto">
                                    {settingsTab === 'general' ? (
                                        <>
                                            <div className="pb-4 border-b border-gray-200 dark:border-neutral-800">
                                                <h4 className={`text-sm font-bold mb-2 ${theme.cardText}`}>백업/복원</h4>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={handleExport} className={`flex flex-col items-center p-2 rounded border border-dashed ${theme.border} ${theme.subText}`}><Download size={16} /><span className="text-xs mt-1">저장</span></button>
                                                    <label className={`flex flex-col items-center p-2 rounded border border-dashed ${theme.border} ${theme.subText}`}><Upload size={16} /><span className="text-xs mt-1">복원</span><input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                                </div>
                                            </div>
                                            <div><label className={`text-xs block mb-1 ${theme.subText}`}>기초 잔액</label><input type="number" value={initialBalance} onChange={(e) => setInitialBalance(Number(e.target.value))} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                            <div><label className={`text-xs block mb-1 ${theme.subText}`}>통화</label><div className="flex gap-2"><button onClick={() => setCurrency('KRW')} className={`flex-1 py-2 text-sm border rounded ${currency === 'KRW' ? 'bg-blue-600 text-white' : theme.input}`}>원 (₩)</button><button onClick={() => setCurrency('CNY')} className={`flex-1 py-2 text-sm border rounded ${currency === 'CNY' ? 'bg-blue-600 text-white' : theme.input}`}>위안 (¥)</button></div></div>
                                        </>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="flex gap-2 p-1 bg-neutral-800 rounded mb-2">
                                                <button onClick={() => setCategoryTypeToAdd('income')} className={`flex-1 py-1.5 text-xs rounded ${categoryTypeToAdd === 'income' ? 'bg-blue-600 text-white' : 'text-gray-400'}`}>수입 항목</button>
                                                <button onClick={() => setCategoryTypeToAdd('expense')} className={`flex-1 py-1.5 text-xs rounded ${categoryTypeToAdd === 'expense' ? 'bg-rose-600 text-white' : 'text-gray-400'}`}>지출 항목</button>
                                            </div>
                                            <div className="flex gap-2">
                                                <input type="text" value={newCategoryName} onChange={(e) => setNewCategoryName(e.target.value)} placeholder="새 항목 이름" className={`flex-1 rounded border px-3 py-2 text-sm ${theme.input}`} />
                                                <button onClick={handleAddCategory} className="bg-blue-600 text-white px-3 py-2 rounded text-sm shrink-0">추가</button>
                                            </div>
                                            <div className="space-y-2 max-h-[200px] overflow-y-auto pr-1">
                                                {categories[categoryTypeToAdd].map(cat => (
                                                    <div key={cat} className={`flex justify-between items-center p-2 rounded border ${theme.border} ${theme.bg}`}>
                                                        <span className={`text-sm ${theme.cardText}`}>{cat}</span>
                                                        <button onClick={() => handleDeleteCategory(categoryTypeToAdd, cat)} className="text-gray-500 hover:text-red-500"><Trash2 size={14} /></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className={`p-4 border-t ${theme.border}`}><button onClick={() => setIsSettingsOpen(false)} className="w-full bg-blue-600 text-white py-2 rounded">닫기</button></div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden ${theme.card}`}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>{editingId ? '수정' : '추가'}</h3><button onClick={() => setIsModalOpen(false)} className={theme.subText}><X size={20} /></button></div>
                                <form onSubmit={handleSaveTransaction} className="p-4 space-y-3">
                                    <div className="flex gap-2">
                                        <div className="flex-1"><label className={`text-xs block mb-1 ${theme.subText}`}>날짜</label><input type="date" required value={newTrans.date} onChange={(e) => setNewTrans({ ...newTrans, date: e.target.value })} className={`w-full rounded border px-2 py-2 text-sm ${theme.input}`} /></div>
                                        <div className="flex-1"><label className={`text-xs block mb-1 ${theme.subText}`}>유형</label><div className="flex gap-1"><button type="button" onClick={() => setNewTrans({ ...newTrans, type: 'income' })} className={`flex-1 py-2 text-sm rounded ${newTrans.type === 'income' ? 'bg-blue-600 text-white' : theme.input}`}>수입</button><button type="button" onClick={() => setNewTrans({ ...newTrans, type: 'expense' })} className={`flex-1 py-2 text-sm rounded ${newTrans.type === 'expense' ? 'bg-rose-600 text-white' : theme.input}`}>지출</button></div></div>
                                    </div>
                                    <div>
                                        <label className={`text-xs block mb-1 ${theme.subText}`}>항목(카테고리)</label>
                                        <select value={newTrans.category} onChange={(e) => setNewTrans({ ...newTrans, category: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`}>
                                            {(newTrans.type === 'income' ? categories.income : categories.expense).map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>금액</label><input type="number" required min="0" placeholder="0" value={newTrans.amount} onChange={(e) => setNewTrans({ ...newTrans, amount: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>내용</label><input type="text" required placeholder="내용 입력" value={newTrans.desc} onChange={(e) => setNewTrans({ ...newTrans, desc: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded mt-2">{editingId ? '수정 완료' : '저장'}</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
