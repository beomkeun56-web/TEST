<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BK v5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        button { touch-action: manipulation; }
        .layout-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .mobile-mode-container {
            max-width: 430px !important; 
            margin: 0 auto;
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            min-height: 100vh;
        }
        /* Glassmorphism */
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .glass-header {
             background: rgba(0, 0, 0, 0.8);
             backdrop-filter: blur(12px);
             border-bottom: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="bg-black text-gray-100 font-sans selection:bg-blue-500 selection:text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { ChevronLeft, ChevronRight, Plus, Minus, X, Wallet, TrendingUp, TrendingDown, Calendar as CalendarIcon, Settings, Moon, Sun, List, LayoutGrid, Download, Upload, Pencil, PieChart, BarChart3, Trash2, Scale, Layers, LineChart, Table2, StickyNote, FolderTree, Tag, ArrowRight, Monitor, Smartphone, MoreHorizontal } from 'lucide-react';

        const APP_VERSION = "v5.2";
        
        const FONT_SIZES = ['text-xs', 'text-sm', 'text-base', 'text-lg', 'text-xl', 'text-2xl'];
        const FONT_LABELS = ['80%', '90%', '100%', '110%', '120%', '130%'];
        const TABLE_FONT_SIZES = ['text-[9px]', 'text-[10px]', 'text-[11px]', 'text-[12px]', 'text-[13px]', 'text-[14px]'];

        const formatCurrency = (amount, currency) => {
            const options = { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 };
            return new Intl.NumberFormat(currency === 'KRW' ? 'ko-KR' : 'zh-CN', options).format(amount);
        };

        const formatCompactNumber = (number) => {
            if (number === 0) return '0';
            const abs = Math.abs(number);
            if (abs < 1000) return new Intl.NumberFormat('ko-KR').format(number);
            if (abs < 10000) { const val = number / 1000; return val.toFixed(val % 1 === 0 ? 0 : 1) + '천'; }
            const val = number / 10000;
            return val.toFixed(val % 1 === 0 ? 0 : 1) + '만';
        };

        const generateCalendarDays = (year, month) => {
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = lastDayOfMonth.getDate();
            const days = [];
            for (let i = 0; i < startDayOfWeek; i++) days.push({ day: null, dateStr: null });
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                days.push({ day: i, dateStr: dateStr });
            }
            return days;
        };

        const DEFAULT_CATEGORIES = {
            income: ['급여', '용돈', '상여금', '금융수입', '기타'],
            expense: ['식비', '교통', '문화', '공과금', '쇼핑', '주거', '의료', '기타']
        };
        const DEFAULT_MAIN_CATEGORIES = {
            income: ['근로소득', '금융소득', '기타'],
            expense: ['고정지출', '변동지출', '저축', '기타']
        };

        function App() {
            const [isLoaded, setIsLoaded] = useState(false);
            const [initialBalance, setInitialBalance] = useState(0);
            const [currency, setCurrency] = useState('KRW'); 
            const [isDarkMode, setIsDarkMode] = useState(true); 
            const [fontIndex, setFontIndex] = useState(2); 
            const [layoutMode, setLayoutMode] = useState('mobile'); 
            
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('calendar');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [transactions, setTransactions] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [mainCategories, setMainCategories] = useState(DEFAULT_MAIN_CATEGORIES);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedDateDetail, setSelectedDateDetail] = useState(null); 
            const [settingsTab, setSettingsTab] = useState('general');
            const [newCategoryName, setNewCategoryName] = useState('');
            const [categoryTypeToAdd, setCategoryTypeToAdd] = useState('expense');
            const [newTrans, setNewTrans] = useState({
                date: new Date().toISOString().split('T')[0], type: 'expense', mainCategory: '', category: '', amount: '', desc: '', memo: '' 
            });

            useEffect(() => {
                const savedData = localStorage.getItem('bk_budget_data_v21');
                const savedFontIndex = localStorage.getItem('bk_budget_font_idx');
                const savedLayout = localStorage.getItem('bk_budget_layout_mode');

                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                        if (parsed.currency) setCurrency(parsed.currency);
                        if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                        if (parsed.transactions) setTransactions(parsed.transactions);
                        if (parsed.categories) setCategories(parsed.categories);
                        if (parsed.mainCategories) setMainCategories(parsed.mainCategories);
                    } catch (e) { console.error(e); }
                } else {
                    const oldData = localStorage.getItem('bk_budget_data_v5');
                    if (oldData) {
                        try {
                            const parsed = JSON.parse(oldData);
                            if (parsed.transactions) setTransactions(parsed.transactions);
                            if (parsed.initialBalance) setInitialBalance(parsed.initialBalance);
                            if (parsed.categories) setCategories(parsed.categories);
                        } catch(e) {}
                    }
                }
                
                if (savedFontIndex !== null) setFontIndex(parseInt(savedFontIndex, 10));
                if (savedLayout) setLayoutMode(savedLayout);
                
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories, mainCategories };
                    localStorage.setItem('bk_budget_data_v21', JSON.stringify(dataToSave)); 
                }
            }, [initialBalance, currency, isDarkMode, transactions, categories, mainCategories, isLoaded]);

            const handleFontUp = () => { const newIndex = Math.min(fontIndex + 1, FONT_SIZES.length - 1); setFontIndex(newIndex); localStorage.setItem('bk_budget_font_idx', newIndex); };
            const handleFontDown = () => { const newIndex = Math.max(fontIndex - 1, 0); setFontIndex(newIndex); localStorage.setItem('bk_budget_font_idx', newIndex); };
            const handleLayoutChange = (mode) => { setLayoutMode(mode); localStorage.setItem('bk_budget_layout_mode', mode); };

            useEffect(() => {
                if (isModalOpen && !editingId) {
                    const currentMainCats = newTrans.type === 'income' ? mainCategories.income : mainCategories.expense;
                    const currentSubCats = newTrans.type === 'income' ? categories.income : categories.expense;
                    setNewTrans(prev => ({ 
                        ...prev, 
                        mainCategory: currentMainCats.length > 0 ? currentMainCats[0] : '',
                        category: currentSubCats.length > 0 ? currentSubCats[0] : ''
                    }));
                }
            }, [newTrans.type, categories, mainCategories, isModalOpen, editingId]);

            const handleExport = () => {
                const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories, mainCategories, exportDate: new Date().toISOString(), version: APP_VERSION };
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `BK_Budget_${APP_VERSION}_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if (window.confirm("복원하시겠습니까?")) {
                            if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                            if (parsed.currency) setCurrency(parsed.currency);
                            if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                            if (parsed.transactions) setTransactions(parsed.transactions);
                            if (parsed.categories) setCategories(parsed.categories);
                            if (parsed.mainCategories) setMainCategories(parsed.mainCategories);
                            alert("복원 완료");
                            setIsSettingsOpen(false);
                        }
                    } catch (err) { alert("파일 오류"); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); 
            const sortedTransactions = useMemo(() => [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date)), [transactions]);

            const dailyStatsMap = useMemo(() => {
                const stats = {};
                let runningBalance = Number(initialBalance); 
                sortedTransactions.forEach(t => {
                    const dateKey = t.date;
                    if (!stats[dateKey]) stats[dateKey] = { income: 0, expense: 0, balance: 0 };
                    if (t.type === 'income') { stats[dateKey].income += Number(t.amount); runningBalance += Number(t.amount); }
                    else { stats[dateKey].expense += Number(t.amount); runningBalance -= Number(t.amount); }
                    stats[dateKey].balance = runningBalance;
                });
                return { stats, finalBalance: runningBalance };
            }, [sortedTransactions, initialBalance]);

            const allTimeStats = useMemo(() => {
                let income = 0; let expense = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') income += Number(t.amount);
                    else expense += Number(t.amount);
                });
                const balance = Number(initialBalance) + income - expense;
                return { income, expense, balance };
            }, [transactions, initialBalance]);

            const yearlyStats = useMemo(() => {
                const monthlyData = Array(12).fill(null).map((_, i) => ({ month: i + 1, income: 0, expense: 0, balance: 0, carryover: 0, totalRevenue: 0 }));
                // 계층형 데이터 (대항목 > 소항목)
                const hierarchyData = { income: {}, expense: {} };
                const yearTransactions = transactions.filter(t => t.date.startsWith(String(year)));
                
                yearTransactions.forEach(t => {
                    const m = new Date(t.date).getMonth(); 
                    const mainCat = t.mainCategory || '기타';
                    const subCat = t.category || '기타';
                    const amt = Number(t.amount);
                    const type = t.type; 

                    if (type === 'income') monthlyData[m].income += amt; else monthlyData[m].expense += amt;

                    // 계층형 집계
                    if (!hierarchyData[type][mainCat]) {
                        hierarchyData[type][mainCat] = { total: 0, monthly: Array(12).fill(0), subs: {} };
                    }
                    hierarchyData[type][mainCat].total += amt; 
                    hierarchyData[type][mainCat].monthly[m] += amt;

                    if (!hierarchyData[type][mainCat].subs[subCat]) {
                        hierarchyData[type][mainCat].subs[subCat] = { total: 0, monthly: Array(12).fill(0) };
                    }
                    hierarchyData[type][mainCat].subs[subCat].total += amt; 
                    hierarchyData[type][mainCat].subs[subCat].monthly[m] += amt;
                });

                let currentCarryover = Number(initialBalance);
                const prevYearTrans = transactions.filter(t => new Date(t.date).getFullYear() < year);
                prevYearTrans.forEach(t => { if(t.type === 'income') currentCarryover += Number(t.amount); else currentCarryover -= Number(t.amount); });
                monthlyData.forEach(s => { s.carryover = currentCarryover; s.totalRevenue = s.carryover + s.income; s.balance = s.totalRevenue - s.expense; currentCarryover = s.balance; });
                return { monthlyData, hierarchyData }; 
            }, [transactions, year, initialBalance]);

            const categoryStats = useMemo(() => {
                const startStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endStr = `${year}-${String(month + 1).padStart(2, '0')}-31`;
                let carryover = Number(initialBalance);
                transactions.forEach(t => { if (t.date < startStr) { if (t.type === 'income') carryover += Number(t.amount); else carryover -= Number(t.amount); } });
                const currentMonthTrans = transactions.filter(t => t.date >= startStr && t.date <= endStr);
                
                // 계층형 분석 (대항목 > 소항목)
                const hierarchy = { income: {}, expense: {} };

                const processTrans = (transList) => {
                    transList.forEach(t => {
                        const type = t.type;
                        const mainCat = t.mainCategory || '기타';
                        const subCat = t.category || '기타';
                        const amt = Number(t.amount);

                        if (!hierarchy[type][mainCat]) hierarchy[type][mainCat] = { total: 0, subs: {} };
                        hierarchy[type][mainCat].total += amt;

                        if (!hierarchy[type][mainCat].subs[subCat]) hierarchy[type][mainCat].subs[subCat] = { total: 0 };
                        hierarchy[type][mainCat].subs[subCat].total += amt;
                    });
                };
                processTrans(currentMonthTrans);

                const sortHierarchy = (data) => {
                    return Object.entries(data).map(([key, val]) => {
                        const sortedSubs = Object.entries(val.subs).map(([subKey, subVal]) => ({ name: subKey, ...subVal })).sort((a, b) => b.total - a.total);
                        return { name: key, ...val, subs: sortedSubs };
                    }).sort((a, b) => b.total - a.total);
                };

                const monthlyIncome = currentMonthTrans.filter(t => t.type === 'income').reduce((a, b) => a + Number(b.amount), 0);
                const monthlyExpense = currentMonthTrans.filter(t => t.type === 'expense').reduce((a, b) => a + Number(b.amount), 0);
                const totalRevenue = carryover + monthlyIncome;
                const finalBalance = totalRevenue - monthlyExpense;

                return {
                    income: sortHierarchy(hierarchy.income),
                    expense: sortHierarchy(hierarchy.expense),
                    monthlyIncome, monthlyExpense, carryover, totalRevenue, finalBalance 
                };
            }, [transactions, year, month, initialBalance]);

            const getBalanceAtDate = (targetDateStr) => {
                let balance = Number(initialBalance); 
                for (const t of sortedTransactions) { if (t.date > targetDateStr) break; if (t.type === 'income') balance += Number(t.amount); else balance -= Number(t.amount); }
                return balance;
            };

            const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const handleNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
            
            const handleSaveTransaction = (e) => {
                e.preventDefault();
                if (!newTrans.amount || !newTrans.desc) return;
                const currentMainCats = newTrans.type === 'income' ? mainCategories.income : mainCategories.expense;
                const currentSubCats = newTrans.type === 'income' ? categories.income : categories.expense;
                const transToSave = { ...newTrans, mainCategory: newTrans.mainCategory || (currentMainCats[0] || '기타'), category: newTrans.category || (currentSubCats[0] || '기타'), amount: Number(newTrans.amount) };
                if (editingId) setTransactions(prev => prev.map(t => t.id === editingId ? { ...transToSave, id: editingId } : t));
                else setTransactions([...transactions, { id: Date.now(), ...transToSave }]);
                setIsModalOpen(false); setEditingId(null); setNewTrans({ ...newTrans, amount: '', desc: '', category: '', mainCategory: '', memo: '' }); setSelectedDateDetail(null);
            };

            const handleEditClick = (transaction) => {
                setEditingId(transaction.id);
                setNewTrans({ date: transaction.date, type: transaction.type, amount: transaction.amount, desc: transaction.desc, category: transaction.category || '', mainCategory: transaction.mainCategory || '', memo: transaction.memo || '' });
                setIsModalOpen(true); setSelectedDateDetail(null);
            };

            const handleDelete = (id) => {
                if (window.confirm("삭제하시겠습니까?")) {
                    setTransactions(transactions.filter(t => t.id !== id));
                    if (selectedDateDetail) setSelectedDateDetail(prev => ({ ...prev, items: prev.items.filter(i => i.id !== id) }));
                }
            };

            const handleDateClick = (dateStr) => {
                if (!dateStr) return;
                const dayTrans = transactions.filter(t => t.date === dateStr);
                setSelectedDateDetail({ dateStr, items: dayTrans });
            };

            const handleAddCategory = (isMain) => {
                if (!newCategoryName.trim()) return;
                const type = categoryTypeToAdd;
                const targetState = isMain ? mainCategories : categories;
                const setTargetState = isMain ? setMainCategories : setCategories;
                if (targetState[type].includes(newCategoryName)) { alert('이미 존재함'); return; }
                setTargetState(prev => ({ ...prev, [type]: [...prev[type], newCategoryName] }));
                setNewCategoryName('');
            };

            const handleDeleteCategory = (isMain, type, name) => {
                const targetState = isMain ? mainCategories : categories;
                const setTargetState = isMain ? setMainCategories : setCategories;
                if (targetState[type].length <= 1) { alert('최소 1개 필수'); return; }
                if (window.confirm('삭제하시겠습니까?')) {
                    setTargetState(prev => ({ ...prev, [type]: prev[type].filter(c => c !== name) }));
                }
            };

            const calendarDays = generateCalendarDays(year, month);
            
            const theme = {
                bg: isDarkMode ? 'bg-black' : 'bg-gray-50',
                text: isDarkMode ? 'text-gray-100' : 'text-gray-800',
                card: isDarkMode ? 'glass-card' : 'bg-white border-gray-200',
                cardText: isDarkMode ? 'text-gray-200' : 'text-gray-900',
                subText: isDarkMode ? 'text-gray-400' : 'text-gray-500',
                border: isDarkMode ? 'border-neutral-800' : 'border-gray-200',
                hover: isDarkMode ? 'hover:bg-neutral-800' : 'hover:bg-gray-50',
                input: isDarkMode ? 'bg-neutral-900 border-neutral-700 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-900',
                header: isDarkMode ? 'glass-header' : 'bg-white border-gray-200',
                th: isDarkMode ? 'bg-neutral-900 text-gray-400' : 'bg-gray-50 text-gray-600',
                gridLine: isDarkMode ? 'border-neutral-800' : 'border-gray-100',
                today: isDarkMode ? 'bg-indigo-900/40' : 'bg-indigo-50/30',
                incomeText: isDarkMode ? 'text-blue-400' : 'text-blue-600',
                incomeBg: isDarkMode ? 'bg-blue-500/20' : 'bg-blue-100',
                expenseText: isDarkMode ? 'text-rose-400' : 'text-rose-600',
                expenseBg: isDarkMode ? 'bg-rose-500/20' : 'bg-red-100',
            };

            if (!isLoaded) return null; 

            const currentFontSizeClass = FONT_SIZES[fontIndex];
            const currentTableFontSize = TABLE_FONT_SIZES[fontIndex];

            const renderCategoryManager = (isMain) => {
                const targetState = isMain ? mainCategories : categories;
                return (
                    <div className="space-y-4">
                        <div className="flex gap-2 p-1 bg-neutral-800 rounded mb-2">
                            <button onClick={() => setCategoryTypeToAdd('income')} className={`flex-1 py-1.5 text-xs rounded ${categoryTypeToAdd === 'income' ? 'bg-blue-600 text-white' : 'text-gray-400'}`}>수입 {isMain ? '대항목' : '소항목'}</button>
                            <button onClick={() => setCategoryTypeToAdd('expense')} className={`flex-1 py-1.5 text-xs rounded ${categoryTypeToAdd === 'expense' ? 'bg-rose-600 text-white' : 'text-gray-400'}`}>지출 {isMain ? '대항목' : '소항목'}</button>
                        </div>
                        <div className="flex gap-2">
                            <input type="text" value={newCategoryName} onChange={(e) => setNewCategoryName(e.target.value)} placeholder="새 항목 이름" className={`flex-1 rounded border px-3 py-2 text-sm ${theme.input}`} />
                            <button onClick={() => handleAddCategory(isMain)} className="bg-blue-600 text-white px-3 py-2 rounded text-sm shrink-0">추가</button>
                        </div>
                        <div className="space-y-2 max-h-[200px] overflow-y-auto pr-1">
                            {targetState[categoryTypeToAdd].map(cat => (
                                <div key={cat} className={`flex justify-between items-center p-2 rounded border ${theme.border} ${theme.bg}`}>
                                    <span className={`text-sm ${theme.cardText}`}>{cat}</span>
                                    <button onClick={() => handleDeleteCategory(isMain, categoryTypeToAdd, cat)} className="text-gray-500 hover:text-red-500"><Trash2 size={14} /></button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            // 모바일 최적화된 대시보드 렌더링
            const renderMobileDashboard = () => (
                <div className={`rounded-2xl p-5 mb-6 ${theme.card} relative overflow-hidden`}>
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={handlePrevMonth} className={`p-2 rounded-full bg-neutral-800/50 hover:bg-neutral-700`}><ChevronLeft size={20}/></button>
                        <h2 className="text-xl font-bold tracking-tight">{year}년 {month + 1}월</h2>
                        <button onClick={handleNextMonth} className={`p-2 rounded-full bg-neutral-800/50 hover:bg-neutral-700`}><ChevronRight size={20}/></button>
                    </div>
                    <div className="text-center mb-6">
                        <p className="text-sm text-gray-400 mb-1">최종 월 잔액</p>
                        <p className={`text-4xl font-bold ${categoryStats.finalBalance >= 0 ? 'text-blue-400' : 'text-rose-400'}`}>{formatCurrency(categoryStats.finalBalance, currency)}</p>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-center divide-x divide-neutral-700/50 bg-neutral-900/30 p-3 rounded-xl border border-neutral-800">
                        <div><p className="text-xs text-gray-500 mb-1">수입</p><p className="text-sm font-bold text-blue-400">{formatCompactNumber(categoryStats.monthlyIncome)}</p></div>
                        <div><p className="text-xs text-gray-500 mb-1">지출</p><p className="text-sm font-bold text-rose-400">{formatCompactNumber(categoryStats.monthlyExpense)}</p></div>
                        <div><p className="text-xs text-gray-500 mb-1">이월</p><p className="text-sm font-bold text-gray-300">{formatCompactNumber(categoryStats.carryover)}</p></div>
                    </div>
                    <div className="mt-4 flex justify-between items-center px-2 pt-3 border-t border-neutral-800">
                        <span className="text-xs text-gray-500 flex items-center gap-1"><Layers size={12}/> 전체 누적 자산</span>
                        <span className="text-sm font-bold text-gray-300">{formatCurrency(allTimeStats.balance, currency)}</span>
                    </div>
                </div>
            );

            // 목록 탭 타임라인 렌더링
            const renderGroupedList = () => {
                const grouped = {};
                transactions.filter(t => t.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`))
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(t => { if (!grouped[t.date]) grouped[t.date] = []; grouped[t.date].push(t); });
                
                const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
                if (dates.length === 0) return <div className={`text-center py-20 ${theme.subText}`}>내역 없음</div>;

                return (
                    <div className="space-y-6">
                        {dates.map(date => {
                            const dayEvents = grouped[date];
                            const dateObj = new Date(date);
                            const dayName = ['일','월','화','수','목','금','토'][dateObj.getDay()];
                            return (
                                <div key={date} className={`rounded-xl overflow-hidden border ${theme.border}`}>
                                    <div className="bg-neutral-900/50 px-4 py-2 border-b border-neutral-800 flex justify-between items-center">
                                        <span className="font-bold text-sm text-gray-300">{date.slice(5)} ({dayName})</span>
                                    </div>
                                    <div className="divide-y divide-neutral-800">
                                        {dayEvents.map(t => (
                                            <div key={t.id} onClick={() => handleEditClick(t)} className={`p-4 flex justify-between items-center ${theme.bg} active:bg-neutral-800 transition-colors cursor-pointer`}>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded border ${t.type === 'income' ? 'border-blue-500/30 text-blue-400 bg-blue-500/10' : 'border-rose-500/30 text-rose-400 bg-rose-500/10'}`}>{t.category}</span>
                                                        <span className="text-sm font-medium text-gray-200">{t.desc}</span>
                                                    </div>
                                                    {t.memo && <p className="text-xs text-gray-500 pl-1">└ {t.memo}</p>}
                                                </div>
                                                <div className={`text-right font-bold ${t.type === 'income' ? 'text-blue-500' : 'text-rose-500'}`}>{t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount, currency).replace(/[₩¥CNY]/g, '').trim()}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            return (
                <div className={`min-h-screen font-sans transition-colors duration-200 ${theme.bg} ${theme.text} overflow-x-hidden ${currentFontSizeClass} text-transition`}>
                    <header className={`sticky top-0 z-50 border-b ${theme.header}`}>
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-2 rounded-lg text-white"><CalendarIcon size={20} /></div>
                                <div className="flex items-end gap-1"><h1 className={`text-xl font-bold tracking-tight ${theme.cardText}`}>BK</h1><span className={`text-xs font-mono mb-1 ${theme.subText}`}>{APP_VERSION}</span></div>
                            </div>
                            <div className="flex items-center gap-1">
                                <div className="flex items-center bg-neutral-800 rounded-lg p-0.5 mr-1 hidden sm:flex">
                                    <button onClick={() => setLayoutMode('pc')} className={`p-1.5 rounded-md ${layoutMode === 'pc' ? 'bg-blue-600 text-white' : 'text-gray-400'}`}><Monitor size={14}/></button>
                                    <button onClick={() => setLayoutMode('mobile')} className={`p-1.5 rounded-md ${layoutMode === 'mobile' ? 'bg-blue-600 text-white' : 'text-gray-400'}`}><Smartphone size={14}/></button>
                                </div>
                                <div className="flex items-center bg-neutral-800 rounded-lg p-0.5 mr-1">
                                    <button onClick={handleFontDown} className="p-1.5 text-gray-400 hover:text-white"><Minus size={14}/></button>
                                    <span className="text-[10px] w-6 text-center text-gray-300 font-mono">{FONT_LABELS[fontIndex]}</span>
                                    <button onClick={handleFontUp} className="p-1.5 text-gray-400 hover:text-white"><Plus size={14}/></button>
                                </div>
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full ${theme.hover} ${theme.subText}`}><Sun size={20} /></button>
                                <button onClick={() => { setIsSettingsOpen(true); setSettingsTab('general'); }} className={`p-2 rounded-full ${theme.hover} ${theme.subText}`}><Settings size={20} /></button>
                                <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className="ml-1 bg-blue-600 text-white px-3 py-2 rounded-md"><Plus size={16} /></button>
                            </div>
                        </div>
                    </header>

                    <div className="w-full flex justify-center bg-black">
                        <main className={`px-4 py-6 pb-20 w-full layout-transition ${layoutMode === 'pc' ? 'max-w-6xl' : 'mobile-mode-container'}`}>
                            
                            {/* 대시보드 */}
                            {layoutMode === 'mobile' ? renderMobileDashboard() : (
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div className={`col-span-1 rounded-xl border p-4 ${theme.card}`}>
                                        <div className="flex justify-between items-center text-sm border-b border-neutral-800 pb-2 mb-2"><span className={theme.subText}>전월 이월</span><span className={theme.cardText}>{formatCurrency(categoryStats.carryover, currency)}</span></div>
                                        <div className="flex justify-between items-center text-sm mb-1"><span className="text-blue-400">수입</span><span className="text-blue-400 font-bold">+{formatCurrency(categoryStats.monthlyIncome, currency)}</span></div>
                                        <div className="flex justify-between items-center pt-2 mt-1 border-t border-neutral-700"><span className="text-sm text-gray-400">총 수입</span><span className={`text-lg font-bold ${theme.cardText}`}>{formatCurrency(categoryStats.totalRevenue, currency)}</span></div>
                                    </div>
                                    <div className={`col-span-1 rounded-xl border p-4 flex flex-col justify-center items-center gap-1 ${theme.card}`}><TrendingDown size={24} className="text-rose-500 mb-1"/><span className={theme.subText}>총 지출</span><span className="text-2xl font-bold text-rose-500">{formatCurrency(categoryStats.monthlyExpense, currency)}</span></div>
                                    <div className={`col-span-1 rounded-xl border p-4 flex flex-col justify-center items-center gap-1 ${theme.card}`}><Wallet size={24} className="text-blue-500 mb-1"/><span className={theme.subText}>월 잔액</span><span className={`text-2xl font-bold ${categoryStats.finalBalance >= 0 ? 'text-blue-500' : 'text-rose-500'}`}>{formatCurrency(categoryStats.finalBalance, currency)}</span></div>
                                </div>
                            )}

                            {/* 탭 메뉴 */}
                            <div className="flex gap-2 mb-4 border-b border-gray-200 dark:border-neutral-800 overflow-x-auto no-scrollbar">
                                <button onClick={() => setActiveTab('calendar')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 whitespace-nowrap ${activeTab === 'calendar' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><LayoutGrid size={18} />달력</button>
                                <button onClick={() => setActiveTab('list')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 whitespace-nowrap ${activeTab === 'list' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><List size={18} />목록</button>
                                <button onClick={() => setActiveTab('stats')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 whitespace-nowrap ${activeTab === 'stats' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><BarChart3 size={18} />통계</button>
                                <button onClick={() => setActiveTab('yearly')} className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 whitespace-nowrap ${activeTab === 'yearly' ? `border-blue-500 text-blue-500` : `border-transparent ${theme.subText}`}`}><Table2 size={18} />연간</button>
                            </div>

                            {/* 캘린더 뷰 */}
                            {activeTab === 'calendar' && (
                                <div className={`rounded-xl shadow border overflow-hidden ${theme.card}`}>
                                    {layoutMode === 'pc' && <div className="flex justify-between items-center p-4 border-b border-neutral-800"><button onClick={handlePrevMonth}><ChevronLeft size={20}/></button><span className={`font-bold ${theme.cardText}`}>{year}년 {month + 1}월</span><button onClick={handleNextMonth}><ChevronRight size={20}/></button></div>}
                                    <div className={`grid grid-cols-7 border-b ${theme.border} ${theme.th}`}>{['일','월','화','수','목','금','토'].map((day,i)=><div key={day} className={`py-3 text-center font-semibold ${i===0?'text-red-500':i===6?'text-blue-500':''}`}>{day}</div>)}</div>
                                    <div className="grid grid-cols-7 auto-rows-fr">
                                        {calendarDays.map((item, idx) => {
                                            if (!item.day) return <div key={`empty-${idx}`} className={`min-h-[80px] sm:min-h-[100px] p-0.5 border-b border-r last:border-r-0 relative cursor-pointer ${theme.gridLine} ${theme.hover} ${isToday ? theme.today : ''}`}></div>;
                                            const dateStats = dailyStatsMap.stats[item.dateStr];
                                            const currentBalance = dateStats ? dateStats.balance : getBalanceAtDate(item.dateStr);
                                            const isToday = item.dateStr === new Date().toISOString().split('T')[0];
                                            const dayTransactions = transactions.filter(t => t.date === item.dateStr);

                                            return (
                                                <div key={item.dateStr} onClick={() => handleDateClick(item.dateStr)} className={`min-h-[80px] sm:min-h-[100px] p-0.5 border-b border-r last:border-r-0 relative cursor-pointer ${theme.gridLine} ${theme.hover} ${isToday ? theme.today : ''}`}>
                                                    <div className="flex flex-col h-full justify-start gap-0.5">
                                                        <div className="flex flex-col w-full gap-0.5 flex-shrink-0">
                                                            <div className="flex justify-between items-start">
                                                                <span className={`text-[0.75em] font-medium w-5 h-5 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : theme.subText}`}>{item.day}</span>
                                                                {/* [수정] 1. 잔액 색상 복구 (흰색/빨강 텍스트만) */}
                                                                <span className={`text-[0.65em] px-1 ${currentBalance < 0 ? 'text-rose-500 font-bold' : 'text-white'}`}>{formatCompactNumber(currentBalance)}</span>
                                                            </div>
                                                            <div className="flex flex-row flex-wrap justify-end gap-1 w-full">
                                                                {/* [수정] 1. 수입/지출 색상 복구 (배경 제거, 텍스트만) */}
                                                                {dateStats?.income > 0 && <span className="text-[0.6em] text-blue-400">+{formatCompactNumber(dateStats.income)}</span>}
                                                                {dateStats?.expense > 0 && <span className="text-[0.6em] text-rose-400">-{formatCompactNumber(dateStats.expense)}</span>}
                                                            </div>
                                                        </div>
                                                        <div className="flex flex-col gap-0.5 overflow-y-auto scrollbar-hide flex-grow max-h-[50px]">
                                                            {dayTransactions.map((t) => (
                                                                <div key={t.id} className={`text-[0.65em] flex items-center gap-1 px-1 py-0.5 rounded ${t.type === 'income' ? 'text-blue-200' : 'text-rose-200'}`}>
                                                                    <span className={`border px-0.5 rounded border-current shrink-0 text-[0.8em] opacity-70`}>{t.category}</span>
                                                                    <span className="truncate">{t.desc}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* 리스트 뷰 */}
                            {activeTab === 'list' && renderGroupedList()}

                            {/* 통계 뷰 */}
                            {activeTab === 'stats' && (
                                <div className="space-y-6 animate-in fade-in zoom-in duration-200">
                                    <div className={`rounded-xl shadow border p-5 ${theme.card}`}>
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className={`font-bold flex items-center gap-2 ${theme.cardText}`}><Scale size={18} className="text-gray-400"/>이번 달 수지</h3>
                                            <span className={`text-lg font-bold ${categoryStats.finalBalance >= 0 ? theme.incomeText : theme.expenseText}`}>{formatCurrency(categoryStats.finalBalance, currency)}</span>
                                        </div>
                                        <div className="relative h-4 bg-neutral-800 rounded-full overflow-hidden mb-2">
                                            <div className="absolute left-0 top-0 h-full bg-blue-500" style={{ width: `${categoryStats.totalRevenue > 0 ? (categoryStats.totalRevenue / (categoryStats.totalRevenue + categoryStats.monthlyExpense)) * 100 : 0}%` }}></div>
                                            <div className="absolute right-0 top-0 h-full bg-rose-500" style={{ width: `${categoryStats.monthlyExpense > 0 ? (categoryStats.monthlyExpense / (categoryStats.totalRevenue + categoryStats.monthlyExpense)) * 100 : 0}%` }}></div>
                                        </div>
                                        <div className="flex justify-between text-[0.8em]">
                                            <span className="text-blue-500">가용(총수입) {formatCurrency(categoryStats.totalRevenue, currency)}</span>
                                            <span className="text-rose-500">지출 {formatCurrency(categoryStats.monthlyExpense, currency)}</span>
                                        </div>
                                    </div>

                                    {/* [수정] 2. 통계 탭에서 수입 분석 표시 보장 (그리드 레이아웃 분기 처리) */}
                                    <div className={`grid gap-4 ${layoutMode === 'pc' ? 'grid-cols-2' : 'grid-cols-1'}`}>
                                        <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                            <h3 className={`font-bold mb-4 flex items-center gap-2 ${theme.cardText}`}><TrendingDown size={18} className="text-rose-500"/>지출 분석</h3>
                                            <div className="space-y-4">
                                                {categoryStats.expense.map((main) => (
                                                    <div key={main.name} className="space-y-2">
                                                        <div className="flex justify-between items-end border-b border-neutral-800 pb-1">
                                                            <span className={`font-bold ${theme.cardText}`}>{main.name}</span>
                                                            <span className={`${theme.expenseText} font-bold`}>{formatCurrency(main.total, currency)}</span>
                                                        </div>
                                                        <div className="space-y-1.5 pl-2 border-l-2 border-neutral-800 ml-1">
                                                            {main.subs.map((sub) => (
                                                                <div key={sub.name}>
                                                                    <div className="flex justify-between items-end text-[0.9em]">
                                                                        <span className={theme.subText}>{sub.name}</span>
                                                                        <span className={theme.cardText}>{formatCurrency(sub.total, currency)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-neutral-800 rounded-full h-1.5 overflow-hidden mt-0.5">
                                                                        <div className="bg-rose-500/50 h-1.5 rounded-full" style={{ width: `${main.total > 0 ? (sub.total / main.total) * 100 : 0}%` }}></div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                                {categoryStats.expense.length === 0 && <p className={`text-center py-4 ${theme.subText}`}>지출 내역이 없습니다.</p>}
                                            </div>
                                        </div>

                                        {/* 수입 분석 섹션 */}
                                        <div className={`rounded-xl shadow border p-4 ${theme.card}`}>
                                            <h3 className={`font-bold mb-4 flex items-center gap-2 ${theme.cardText}`}><TrendingUp size={18} className="text-blue-500"/>수입 분석</h3>
                                            <div className="space-y-4">
                                                {categoryStats.income.map((main) => (
                                                    <div key={main.name} className="space-y-2">
                                                        <div className="flex justify-between items-end border-b border-neutral-800 pb-1">
                                                            <span className={`font-bold ${theme.cardText}`}>{main.name}</span>
                                                            <span className={`${theme.incomeText} font-bold`}>{formatCurrency(main.total, currency)}</span>
                                                        </div>
                                                        <div className="space-y-1.5 pl-2 border-l-2 border-neutral-800 ml-1">
                                                            {main.subs.map((sub) => (
                                                                <div key={sub.name}>
                                                                    <div className="flex justify-between items-end text-[0.9em]">
                                                                        <span className={theme.subText}>{sub.name}</span>
                                                                        <span className={theme.cardText}>{formatCurrency(sub.total, currency)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-neutral-800 rounded-full h-1.5 overflow-hidden mt-0.5">
                                                                        <div className="bg-blue-500/50 h-1.5 rounded-full" style={{ width: `${main.total > 0 ? (sub.total / main.total) * 100 : 0}%` }}></div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                                {categoryStats.income.length === 0 && <p className={`text-center py-4 ${theme.subText}`}>수입 내역이 없습니다.</p>}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* 연간 뷰 */}
                            {activeTab === 'yearly' && (
                                <div className={`rounded-xl shadow border p-2 animate-in fade-in zoom-in duration-200 ${theme.card}`}>
                                    <div className="flex justify-between items-center mb-4 px-2">
                                        <h3 className={`font-bold flex items-center gap-2 ${theme.cardText}`}>
                                            <Table2 size={18} className="text-gray-400"/>
                                            {year}년 계층형 흐름
                                        </h3>
                                        <span className={`text-[0.9em] ${theme.subText}`}>1월 - 12월</span>
                                    </div>
                                    
                                    {layoutMode === 'mobile' ? (
                                        <div className="space-y-4 px-1">
                                            {yearlyStats.monthlyData.map((stat, i) => (
                                                <div key={i} className="bg-neutral-800/40 p-4 rounded-xl border border-neutral-700/50">
                                                    <div className="flex justify-between items-end mb-3 border-b border-neutral-700/50 pb-2">
                                                        <span className="text-2xl font-bold text-white">{stat.month}<span className="text-sm font-normal text-gray-500 ml-1">월</span></span>
                                                        <span className={`text-lg font-bold ${stat.balance >= 0 ? 'text-blue-400' : 'text-rose-400'}`}>{formatCurrency(stat.balance, currency)}</span>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                                        <div><span className="text-xs text-blue-500/70 block mb-0.5">수입</span><span className="text-blue-300 font-medium">{formatCurrency(stat.income, currency)}</span></div>
                                                        <div className="text-right"><span className="text-xs text-rose-500/70 block mb-0.5">지출</span><span className="text-rose-300 font-medium">{formatCurrency(stat.expense, currency)}</span></div>
                                                    </div>
                                                    <div className="mt-3 pt-2 border-t border-neutral-700/50 flex justify-between items-center">
                                                        <span className="text-xs text-gray-600">전월 이월</span>
                                                        <span className="text-xs text-gray-400">{formatCurrency(stat.carryover, currency)}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto border border-neutral-800 rounded-lg">
                                            <table className={`w-full ${currentTableFontSize} text-left table-fixed`}>
                                                <thead className={`bg-neutral-900 ${theme.subText}`}>
                                                    <tr>
                                                        <th className="px-1 py-2 border-r border-neutral-800 font-bold text-gray-300 w-[60px] max-w-[60px] whitespace-nowrap overflow-hidden text-ellipsis">구분</th>
                                                        {[...Array(12)].map((_, i) => <th key={i} className="px-0.5 py-2 text-center border-r border-neutral-800 last:border-0 w-[6%]">{i+1}</th>)}
                                                        <th className="px-1 py-2 text-right bg-neutral-900 border-l border-neutral-800 font-bold text-gray-300 w-[13%]">합계</th>
                                                    </tr>
                                                </thead>
                                                <tbody className={`divide-y divide-neutral-800 ${theme.cardText}`}>
                                                    {/* 요약 행 */}
                                                    <tr className="bg-neutral-800/80 font-bold">
                                                        <td className="px-1 py-2 border-r border-neutral-700 text-gray-400 truncate">전월 이월</td>
                                                        {yearlyStats.monthlyData.map((stat, i) => <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-gray-400 truncate">{formatCompactNumber(stat.carryover)}</td>)}
                                                        <td className="px-1 py-2 text-right border-l border-neutral-700 text-gray-400">-</td>
                                                    </tr>
                                                    {/* ... 수입/지출/잔액 행들 ... */}
                                                    <tr className="bg-neutral-800/50 font-bold">
                                                        <td className="px-1 py-2 border-r border-neutral-700 text-blue-400 truncate">월 수입</td>
                                                        {yearlyStats.monthlyData.map((stat, i) => <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-blue-400 truncate">{formatCompactNumber(stat.income)}</td>)}
                                                        <td className="px-1 py-2 text-right border-l border-neutral-700 text-blue-400 truncate">{formatCompactNumber(yearlyStats.monthlyData.reduce((a, b) => a + b.income, 0))}</td>
                                                    </tr>
                                                    <tr className="bg-neutral-800/50 font-bold">
                                                        <td className="px-1 py-2 border-r border-neutral-700 text-rose-400 truncate">월 지출</td>
                                                        {yearlyStats.monthlyData.map((stat, i) => <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-rose-400 truncate">{formatCompactNumber(stat.expense)}</td>)}
                                                        <td className="px-1 py-2 text-right border-l border-neutral-700 text-rose-400 truncate">{formatCompactNumber(yearlyStats.monthlyData.reduce((a, b) => a + b.expense, 0))}</td>
                                                    </tr>
                                                    <tr className="bg-neutral-800/80 font-bold border-b-2 border-neutral-700">
                                                        <td className="px-1 py-2 border-r border-neutral-700 text-white truncate">월 잔액</td>
                                                        {yearlyStats.monthlyData.map((stat, i) => <td key={i} className={`px-0.5 py-2 text-right border-r border-neutral-800 truncate ${stat.balance >= 0 ? 'text-blue-300' : 'text-rose-300'}`}>{formatCompactNumber(stat.balance)}</td>)}
                                                        <td className="px-1 py-2 text-right border-l border-neutral-700 text-white truncate">{formatCompactNumber(yearlyStats.monthlyData.reduce((a, b) => a + b.balance, 0))}</td>
                                                    </tr>

                                                    {/* [수정] 3. PC 연간 뷰 - 소항목 추가 복구 */}
                                                    <tr className="bg-blue-900/30 font-bold border-b border-blue-900"><td colSpan="14" className="px-1 py-2 text-blue-400 truncate pl-2">수입 내역</td></tr>
                                                    {Object.entries(yearlyStats.hierarchyData.income).map(([mainCat, data]) => (
                                                        <React.Fragment key={mainCat}>
                                                            <tr className="bg-neutral-800/30 font-bold">
                                                                <td className="px-1 py-2 border-r border-neutral-800 text-blue-200 pl-2 border-l-2 border-l-blue-500 truncate">{mainCat}</td>
                                                                {data.monthly.map((amt, i) => <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-blue-200 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>)}
                                                                <td className="px-1 py-2 text-right border-l border-neutral-800 text-blue-200 truncate">{formatCompactNumber(data.total)}</td>
                                                            </tr>
                                                            {/* 소항목 렌더링 복구 */}
                                                            {Object.entries(data.subs).map(([subCat, subData]) => (
                                                                <tr key={`${mainCat}-${subCat}`} className="hover:bg-neutral-800/50 text-neutral-400">
                                                                    <td className="px-1 py-1.5 border-r border-neutral-800 pl-4 truncate">└ {subCat}</td>
                                                                    {subData.monthly.map((amt, i) => <td key={i} className="px-0.5 py-1.5 text-right border-r border-neutral-800 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>)}
                                                                    <td className="px-1 py-1.5 text-right border-l border-neutral-800 truncate">{formatCompactNumber(subData.total)}</td>
                                                                </tr>
                                                            ))}
                                                        </React.Fragment>
                                                    ))}

                                                    <tr className="bg-rose-900/30 font-bold border-b border-rose-900"><td colSpan="14" className="px-1 py-2 text-rose-400 truncate pl-2">지출 내역</td></tr>
                                                    {Object.entries(yearlyStats.hierarchyData.expense).map(([mainCat, data]) => (
                                                        <React.Fragment key={mainCat}>
                                                            <tr className="bg-neutral-800/30 font-bold">
                                                                <td className="px-1 py-2 border-r border-neutral-800 text-rose-200 pl-2 border-l-2 border-l-rose-500 truncate">{mainCat}</td>
                                                                {data.monthly.map((amt, i) => <td key={i} className="px-0.5 py-2 text-right border-r border-neutral-800 text-rose-200 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>)}
                                                                <td className="px-1 py-2 text-right border-l border-neutral-800 text-rose-200 truncate">{formatCompactNumber(data.total)}</td>
                                                            </tr>
                                                            {Object.entries(data.subs).map(([subCat, subData]) => (
                                                                <tr key={`${mainCat}-${subCat}`} className="hover:bg-neutral-800/50 text-neutral-400">
                                                                    <td className="px-1 py-1.5 border-r border-neutral-800 pl-4 truncate">└ {subCat}</td>
                                                                    {subData.monthly.map((amt, i) => <td key={i} className="px-0.5 py-1.5 text-right border-r border-neutral-800 truncate">{amt > 0 ? formatCompactNumber(amt) : ''}</td>)}
                                                                    <td className="px-1 py-1.5 text-right border-l border-neutral-800 truncate">{formatCompactNumber(subData.total)}</td>
                                                                </tr>
                                                            ))}
                                                        </React.Fragment>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            )}
                        </main>
                    </div>
                    {/* 모달 등은 생략하지 않고 그대로 유지됨 */}
                     {selectedDateDetail && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={() => setSelectedDateDetail(null)}>
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden ${theme.card}`} onClick={e => e.stopPropagation()}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>{selectedDateDetail.dateStr}</h3><button onClick={() => setSelectedDateDetail(null)} className={theme.subText}><X size={20} /></button></div>
                                <div className="max-h-[50vh] overflow-y-auto p-2 space-y-2">
                                    {selectedDateDetail.items.map(t => (
                                        <div key={t.id} className={`flex justify-between items-center p-3 rounded border ${theme.border} ${theme.bg}`}>
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded border border-neutral-700 text-neutral-400`}>{t.mainCategory || '기타'}</span>
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded border ${t.type === 'income' ? 'border-blue-500 text-blue-500' : 'border-rose-500 text-rose-500'}`}>{t.category}</span>
                                                </div>
                                                <p className={`font-medium ${theme.cardText}`}>{t.desc}</p>
                                                {t.memo && <p className="text-[10px] text-gray-500 mt-1">📝 {t.memo}</p>}
                                            </div>
                                            <div className="flex items-center gap-2"><span className={`font-bold ${t.type === 'income' ? theme.incomeText : theme.expenseText}`}>{formatCurrency(t.amount, currency)}</span><button onClick={() => handleEditClick(t)}><Pencil size={16} className="text-gray-400"/></button><button onClick={() => handleDelete(t.id)}><X size={16} className="text-gray-400"/></button></div>
                                        </div>
                                    ))}
                                    {selectedDateDetail.items.length === 0 && <div className={`text-center py-4 ${theme.subText}`}>내역 없음</div>}
                                </div>
                                <div className="p-2 border-t border-gray-100 dark:border-neutral-800"><button onClick={() => { setEditingId(null); setIsModalOpen(true); setNewTrans(prev => ({...prev, date: selectedDateDetail.dateStr, amount: '', desc: ''})); setSelectedDateDetail(null); }} className="w-full py-3 rounded-lg border border-dashed border-blue-500/30 text-blue-500 text-sm flex items-center justify-center gap-2"><Plus size={16} /> 추가하기</button></div>
                            </div>
                        </div>
                    )}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh] ${theme.card}`}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>설정</h3><button onClick={() => setIsSettingsOpen(false)} className={theme.subText}><X size={20} /></button></div>
                                <div className={`flex border-b ${theme.border}`}>
                                    <button onClick={() => setSettingsTab('general')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'general' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>기본 설정</button>
                                    <button onClick={() => setSettingsTab('main_category')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'main_category' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>대항목 관리</button>
                                    <button onClick={() => setSettingsTab('sub_category')} className={`flex-1 py-3 text-sm font-medium ${settingsTab === 'sub_category' ? 'text-blue-500 border-b-2 border-blue-500' : theme.subText}`}>소항목 관리</button>
                                </div>
                                <div className="p-4 space-y-4 overflow-y-auto">
                                    {settingsTab === 'general' ? (
                                        <>
                                            <div className="pb-4 border-b border-gray-200 dark:border-neutral-800">
                                                <h4 className={`text-sm font-bold mb-2 ${theme.cardText}`}>백업/복원</h4>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={handleExport} className={`flex flex-col items-center p-2 rounded border border-dashed ${theme.border} ${theme.subText}`}><Download size={16} /><span className="text-xs mt-1">저장</span></button>
                                                    <label className={`flex flex-col items-center p-2 rounded border border-dashed ${theme.border} ${theme.subText}`}><Upload size={16} /><span className="text-xs mt-1">복원</span><input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                                </div>
                                            </div>
                                            <div><label className={`text-xs block mb-1 ${theme.subText}`}>기초 잔액</label><input type="number" value={initialBalance} onChange={(e) => setInitialBalance(Number(e.target.value))} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                            <div><label className={`text-xs block mb-1 ${theme.subText}`}>통화</label><div className="flex gap-2"><button onClick={() => setCurrency('KRW')} className={`flex-1 py-2 text-sm border rounded ${currency === 'KRW' ? 'bg-blue-600 text-white' : theme.input}`}>원 (₩)</button><button onClick={() => setCurrency('CNY')} className={`flex-1 py-2 text-sm border rounded ${currency === 'CNY' ? 'bg-blue-600 text-white' : theme.input}`}>위안 (¥)</button></div></div>
                                        </>
                                    ) : (
                                        renderCategoryManager(settingsTab === 'main_category')
                                    )}
                                </div>
                                <div className={`p-4 border-t ${theme.border}`}><button onClick={() => setIsSettingsOpen(false)} className="w-full bg-blue-600 text-white py-2 rounded">닫기</button></div>
                            </div>
                        </div>
                    )}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className={`rounded-xl shadow-xl w-full max-w-sm overflow-hidden ${theme.card}`}>
                                <div className={`px-4 py-3 border-b flex justify-between items-center ${theme.border}`}><h3 className={`font-bold ${theme.cardText}`}>{editingId ? '수정' : '추가'}</h3><button onClick={() => setIsModalOpen(false)} className={theme.subText}><X size={20} /></button></div>
                                <form onSubmit={handleSaveTransaction} className="p-4 space-y-3">
                                    <div className="flex gap-2">
                                        <div className="flex-1"><label className={`text-xs block mb-1 ${theme.subText}`}>날짜</label><input type="date" required value={newTrans.date} onChange={(e) => setNewTrans({ ...newTrans, date: e.target.value })} className={`w-full rounded border px-2 py-2 text-sm ${theme.input}`} /></div>
                                        <div className="flex-1"><label className={`text-xs block mb-1 ${theme.subText}`}>유형</label><div className="flex gap-1"><button type="button" onClick={() => setNewTrans({ ...newTrans, type: 'income' })} className={`flex-1 py-2 text-sm rounded ${newTrans.type === 'income' ? 'bg-blue-600 text-white' : theme.input}`}>수입</button><button type="button" onClick={() => setNewTrans({ ...newTrans, type: 'expense' })} className={`flex-1 py-2 text-sm rounded ${newTrans.type === 'expense' ? 'bg-rose-600 text-white' : theme.input}`}>지출</button></div></div>
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className={`text-xs block mb-1 ${theme.subText}`}>대항목</label>
                                            <select value={newTrans.mainCategory} onChange={(e) => setNewTrans({ ...newTrans, mainCategory: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`}>
                                                {(newTrans.type === 'income' ? mainCategories.income : mainCategories.expense).map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="flex-1">
                                            <label className={`text-xs block mb-1 ${theme.subText}`}>소항목</label>
                                            <select value={newTrans.category} onChange={(e) => setNewTrans({ ...newTrans, category: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`}>
                                                {(newTrans.type === 'income' ? categories.income : categories.expense).map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>금액</label><input type="number" required min="0" placeholder="0" value={newTrans.amount} onChange={(e) => setNewTrans({ ...newTrans, amount: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>내용</label><input type="text" required placeholder="내용 입력" value={newTrans.desc} onChange={(e) => setNewTrans({ ...newTrans, desc: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <div><label className={`text-xs block mb-1 ${theme.subText}`}>메모</label><input type="text" placeholder="메모 (목록에만 표시됨)" value={newTrans.memo} onChange={(e) => setNewTrans({ ...newTrans, memo: e.target.value })} className={`w-full rounded border px-3 py-2 text-sm ${theme.input}`} /></div>
                                    <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded mt-2">{editingId ? '수정 완료' : '저장'}</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
